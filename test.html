<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comparador Agente ↔ Chunior — Herramienta</title>
<style>
  :root{--bg:#0b1220;--card:#0f1726;--muted:#9fb0c0;--accent:#06b6d4;--ok:#16a34a;--bad:#ef4444}
  *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#071020,#071827);color:#e6eef6;padding:20px}
  .wrap{max-width:1100px;margin:0 auto}
  h1{margin:0 0 12px 0;font-size:20px}
  .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=file], textarea, select, input[type=number]{
    background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit;padding:8px;border-radius:8px
  }
  .file-col{min-width:200px}
  .btn{background:linear-gradient(90deg,var(--accent),#3dd9f0);color:#042a31;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  textarea{width:100%;min-height:120px;resize:vertical}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left;color:#dff6fb}
  th{background:rgba(0,0,0,0.12);position:sticky;top:0}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
  .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .ok{color:var(--ok);font-weight:800}
  .bad{color:var(--bad);font-weight:800}
  .summary{display:flex;gap:12px;justify-content:space-between;margin-top:10px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center}
  @media (max-width:900px){ .row{flex-direction:column} table{font-size:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Comparador Agente ↔ Chunior</h1>
    <div class="card">
      <div class="row">
        <div class="file-col">
          <label>Archivos Agente / Sub-agente (puedes seleccionar varios)</label>
          <input id="inputAgentFiles" type="file" accept=".csv" multiple />
          <div class="small muted">Formato soportado: distintos CSV de agente / sub-agente. Se detectan automáticamente.</div>
        </div>

        <div style="flex:1">
          <label>Pegar o cargar Chunior (texto) — si pegás, pega todo y luego "Parsear Chunior"</label>
          <textarea id="chuniorText" placeholder="Pega aquí las líneas de chunior (cada movimiento en una fila) o arrastra un archivo de texto"></textarea>
          <div class="controls">
            <input id="chuniorFile" type="file" accept=".txt,.csv" />
            <button id="btnParseChunior" class="btn">Parsear Chunior</button>
            <button id="btnParseAgents" class="btn">Parsear Agentes</button>
            <div style="margin-left:auto" class="muted small">Ejemplo chunior: <code>7048312	15-11-2025 07:50:02	agustinapc02	846 - BENITEZ 02	$ -10.000,00	karpe9427</code></div>
          </div>
        </div>
      </div>

      <div class="filters">
        <label>Operador:
          <select id="filterOperator"><option value="">(todos)</option></select>
        </label>
        <label>Billetera:
          <select id="filterWallet"><option value="">(todas)</option></select>
        </label>
        <label>Tipo:
          <select id="filterType"><option value="both">Ambos</option><option value="in">Ingresos</option><option value="out">Egresos</option></select>
        </label>
        <label>Match:
          <select id="filterMatch"><option value="all">Todos</option><option value="ok">Sólo OK</option><option value="missing">Sin Par</option><option value="diff">Con Diferencia</option></select>
        </label>

        <div style="margin-left:auto" class="actions">
          <button id="btnMatch" class="btn">Ejecutar matching</button>
          <button id="btnExportCSV" class="btn">Exportar CSV</button>
          <button id="btnCopyForExcel" class="btn">Copiar (col A = usuario, col G = turno)</button>
        </div>
      </div>

      <div class="summary">
        <div>
          <div><strong id="totalsCount">0 movimientos</strong></div>
          <div class="small">Agente: <span id="totalAgent">$0</span> · Chunior: <span id="totalChunior">$0</span> · Diferencia: <span id="totalDiff" class="bad">$0</span></div>
        </div>
        <div class="small">Detectados: Operadores <span id="detOps">-</span> · Billeteras <span id="detWallets">-</span></div>
      </div>

      <div id="resultsArea" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* ======= Utilidades ======= */

function parseCSVLine(line){
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } continue; }
    if(ch===',' && !inQ){ res.push(cur); cur=''; continue; }
    cur += ch;
  }
  res.push(cur);
  return res;
}

function normalizeUser(u){ if(!u && u!==0) return ''; return String(u).trim().toLowerCase(); }

function parseAmount(raw){
  if(raw===null||raw===undefined) return NaN;
  let s = String(raw).trim();
  // Remove currency symbols and spaces
  s = s.replace(/\u00A0/g,' ').replace(/\s+/g,' ');
  s = s.replace(/\$/g,'').trim();
  // Handle negatives sign either before or after $
  // Remove dots as thousands separator, convert comma decimal to dot
  // Example: "-10.000,00" => -10000
  // Example: " -10.000,00" or "- 10.000,00" or "-10.000,00"
  // Also handle formats like "10000" or "10.000"
  // Remove non numeric except ., - and ,
  s = s.replace(/[^0-9\-,\.]/g,'');
  // Handle case "-10.000,00" or "-10.000" or "10.000,00"
  const negative = (s.indexOf('-') !== -1);
  s = s.replace(/-/g,'');
  // If contains both . and , assume . thousands, , decimals
  if(s.indexOf('.') !== -1 && s.indexOf(',') !== -1){
    s = s.replace(/\./g,'').replace(/,/g,'.');
  } else if(s.indexOf('.') !== -1 && s.indexOf(',') === -1){
    // ambiguous: could be decimal or thousands. We'll assume '.' as thousands (since chunior uses '.' thousands)
    s = s.replace(/\./g,'');
  } else if(s.indexOf(',') !== -1){
    // assume comma decimal
    s = s.replace(/,/g,'.');
  }
  let num = parseFloat(s);
  if(isNaN(num)) return NaN;
  if(negative) num = -Math.abs(num);
  return num;
}

function parseDateTime(text){
  if(!text) return null;
  // Accept formats like "2025-11-10 13:48:38" or "10-11-2025 13:48:45"
  const t = String(text).trim();
  // ISO-like?
  if(/^\d{4}-\d{2}-\d{2}/.test(t)) return new Date(t.replace(' ','T'));
  // dd-mm-yyyy hh:mm:ss
  const m = t.match(/^(\d{2})-(\d{2})-(\d{4})\s+(\d{2}:\d{2}:\d{2})/);
  if(m){
    const d = `${m[3]}-${m[2]}-${m[1]} ${m[4]}`; return new Date(d.replace(' ','T'));
  }
  // fallback
  const d = new Date(t);
  return isNaN(d.getTime()) ? null : d;
}

function computeTurno(date){
  if(!date) return 'TN';
  const h = date.getHours();
  if(h>=6 && h<14) return 'TM';
  if(h>=14 && h<22) return 'TT';
  return 'TN';
}

function fmtMoney(n){
  if(isNaN(n)) return '$0';
  return '$' + Number(n).toLocaleString('de-DE', {minimumFractionDigits: 0, maximumFractionDigits: 2});
}

/* ======= Lectura de archivos / parseo ======= */

let agentRecords = []; // {source, fechaStr, fechaObj, monto, usuario, tipo(in/out), raw}
let chuniorRecords = []; // {lineIdx, fechaStr, fechaObj, operador, billetera, monto, usuario, tipo, raw}

document.getElementById('chuniorFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text(); document.getElementById('chuniorText').value = txt; showMsg('Archivo chunior cargado en textarea');
});

document.getElementById('btnParseAgents').addEventListener('click', ()=> parseAgentFiles());
document.getElementById('btnParseChunior').addEventListener('click', ()=> parseChuniorFromTextarea());

document.getElementById('inputAgentFiles').addEventListener('change', ()=> { /* leave for manual parse button */ });

async function parseAgentFiles(){
  agentRecords = [];
  const files = Array.from(document.getElementById('inputAgentFiles').files || []);
  if(files.length===0){ alert('Seleccioná al menos un archivo de agente/sub-agente'); return; }
  for(const f of files){
    const txt = await f.text();
    parseAgentText(txt, f.name);
  }
  showMsg(`Parsed ${agentRecords.length} movimientos desde ${files.length} archivos de agente.`);
  renderSummaryDetectors();
}

function parseAgentText(text, sourceName){
  // split lines, remove leading "sep=" or headers
  const lines = text.split(/\r?\n/).map(l=>l.replace(/\uFEFF/g,'')).filter(l=>l.trim() !== '');
  // drop leading lines until we find a line with a date-like thing
  let start=0;
  while(start<lines.length && !/^\d{4}[-/]\d{2}[-/]\d{2}|^\d{4}-\d{2}-\d{2}|^Fecha/i.test(lines[start]) && start<3) start++;
  // If first line contains "sep=" drop it
  const cleaned = lines.filter(l=>!/^sep=/i.test(l));
  // detect header row by presence of "Fecha" or "Cantidad"
  let idx0 = 0;
  if(/Fecha/i.test(cleaned[0]) && /Cantidad/i.test(cleaned[0])) idx0=1;
  for(let i=idx0;i<cleaned.length;i++){
    const line = cleaned[i].trim();
    if(!line) continue;
    const cols = parseCSVLine(line);
    // Possible formats:
    // AGENTE: Fecha,Estado,Cantidad,Tipo,Alias,Balance
    // SUBAGENTE: Fecha,Tipo,Estado,Cantidad,Balance,Alias del agente,Alias del jugador
    let fecha = cols[0] || '';
    let montoRaw='';
    let usuario='';
    if(cols.length >= 6 && (cols[5] || cols[4])) {
      // try to detect: if header has "Alias del jugador" or last col looks like user
      if(cols.length>=7){
        // subagente likely
        montoRaw = cols[3];
        usuario = cols[6] || cols[5] || '';
      } else {
        // agent possible
        // try to detect by checking if second col is number-like or not
        // We'll attempt both fallbacks
        if(!isNaN(parseAmount(cols[2])) && cols[4] && !/\d{4}/.test(cols[4])){
          // agent format maybe Date,Estado,Cantidad,Tipo,Alias,Balance but columns shift sometimes
          montoRaw = cols[2];
          usuario = cols[4] || cols[5] || '';
        } else {
          // fallback: assume Fecha,Estado,Cantidad,Tipo,Alias,Balance
          montoRaw = cols[2] || cols[3] || '';
          usuario = cols[4] || cols[5] || cols[6] || '';
        }
      }
    } else {
      // fallback: try pick any column that looks like amount and any that looks like username
      montoRaw = cols.find(c => /[\d\.\,]/.test(c) && /[0-9]/.test(c)) || '';
      usuario = cols[cols.length-1] || '';
    }
    const monto = parseAmount(montoRaw);
    const fechaObj = parseDateTime(fecha);
    const usuarioN = normalizeUser(usuario);
    if(!usuarioN) continue;
    const tipo = (monto < 0) ? 'out' : 'in';
    agentRecords.push({ source: sourceName, fechaStr: fecha, fechaObj, monto, usuario: usuarioN, tipo, raw: line });
  }
}

/* Parse chunior content from textarea */
function parseChuniorFromTextarea(){
  chuniorRecords = [];
  const raw = document.getElementById('chuniorText').value || '';
  if(!raw.trim()){ alert('Pega o carga el texto de chunior primero.'); return; }
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l !== '');
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    // chunior format: maybe tab separated or multiple spaces. First col ID optional.
    // We'll split by tabs first, else by 2+ spaces.
    let parts = line.split(/\t+/).map(p=>p.trim()).filter(p=>p!=='');
    if(parts.length < 5){
      parts = line.split(/\s{2,}/).map(p=>p.trim()).filter(p=>p!=='');
    }
    if(parts.length < 5){
      // as fallback, split by space and try to reconstruct date/time
      parts = line.split(/\s+/).filter(p=>p!=='');
    }
    // Typical chunk positions expected: [id, date time, operador, billetera, $ monto, usuario]
    // Or: [date time, operador, billetera, $ monto, usuario]
    let idx = 0;
    if(parts.length >= 6 && /^\d+$/.test(parts[0])) idx = 1; // skip id
    // Now parts[idx] should contain date/time maybe combined
    let fechaPart = parts[idx] || '';
    // If date and time were split we may need to combine
    if(parts[idx+1] && /^\d{2}:\d{2}:\d{2}$/.test(parts[idx+1])) {
      fechaPart = `${parts[idx]} ${parts[idx+1]}`;
      idx++;
    }
    const operador = parts[idx+1] || '';
    const billetera = parts[idx+2] || parts[idx+1] || '';
    const montoRaw = parts[idx+3] || '';
    const usuario = parts[idx+4] || parts[parts.length-1] || '';
    const monto = parseAmount(montoRaw || parts[parts.length-2] || '');
    const fechaObj = parseDateTime(fechaPart);
    const usuarioN = normalizeUser(usuario);
    if(!usuarioN) continue;
    const tipo = (monto < 0) ? 'out' : 'in';
    // tidy billetera: extract name after '-' if present
    let billeteraName = String(billetera).trim();
    const dash = billeteraName.indexOf('-');
    if(dash !== -1){
      billeteraName = billeteraName.slice(dash+1).trim();
    }
    chuniorRecords.push({ lineIdx: i, fechaStr: fechaPart, fechaObj, operador: operador.toLowerCase(), billetera: billeteraName, monto, usuario: usuarioN, tipo, raw: line });
  }
  showMsg(`Parsed ${chuniorRecords.length} movimientos desde chunior.`);
  renderSummaryDetectors();
}

/* ======= Matching ======= */

let matchResults = []; // array of { agent: record|null, chunior: record|null, status: 'ok'|'missingAgent'|'missingChunior'|'diff' }

function runMatching(){
  matchResults = [];
  // copy arrays
  const agents = agentRecords.map((a,i)=> ({...a, _i:i, matched:false}) ).sort((a,b)=>( (a.fechaObj||new Date(0)) - (b.fechaObj||new Date(0)) ));
  const chs = chuniorRecords.map((c,i)=> ({...c, _i:i, matched:false}) ).sort((a,b)=>( (a.fechaObj||new Date(0)) - (b.fechaObj||new Date(0)) ));

  // greedy match: for each agent record, try find the earliest chunior record with same user and same amount
  for(const a of agents){
    let foundIndex = -1;
    for(let j=0;j<chs.length;j++){
      const c = chs[j];
      if(c.matched) continue;
      if(a.usuario === c.usuario && Number(a.monto) === Number(c.monto)){
        foundIndex = j; break;
      }
    }
    if(foundIndex !== -1){
      const c = chs[foundIndex];
      a.matched = true; c.matched = true;
      matchResults.push({ agent: a, chunior: c, status: 'ok' });
    } else {
      // try to find same user but different amount -> discrepancy
      let foundIndex2 = -1;
      for(let j=0;j<chs.length;j++){
        const c = chs[j];
        if(c.matched) continue;
        if(a.usuario === c.usuario){
          foundIndex2 = j; break;
        }
      }
      if(foundIndex2 !== -1){
        const c = chs[foundIndex2];
        a.matched = true; c.matched = true;
        matchResults.push({ agent: a, chunior: c, status: 'diff' });
      } else {
        // agent only
        a.matched = true;
        matchResults.push({ agent: a, chunior: null, status: 'missingChunior' });
      }
    }
  }

  // any chunior left unmatched -> missingAgent
  for(const c of chs){
    if(!c.matched){
      matchResults.push({ agent: null, chunior: c, status: 'missingAgent' });
    }
  }

  // compute totals
  const totalAgent = agentRecords.reduce((s,r)=> s + (isNaN(r.monto)?0:r.monto), 0);
  const totalChunior = chuniorRecords.reduce((s,r)=> s + (isNaN(r.monto)?0:r.monto), 0);
  document.getElementById('totalAgent').textContent = fmtMoney(totalAgent);
  document.getElementById('totalChunior').textContent = fmtMoney(totalChunior);
  const diff = (totalAgent - totalChunior);
  const diffEl = document.getElementById('totalDiff'); diffEl.textContent = fmtMoney(diff);
  diffEl.className = (Math.abs(diff) < 0.001) ? 'small' : 'bad';
  document.getElementById('totalsCount').textContent = `${matchResults.length} filas comparadas`;

  renderResults();
}

/* ======= Render / filters ======= */

function renderSummaryDetectors(){
  const ops = new Set(chuniorRecords.map(c=>c.operador).filter(Boolean));
  const wallets = new Set(chuniorRecords.map(c=>c.billetera).filter(Boolean));
  const opSel = document.getElementById('filterOperator');
  const walSel = document.getElementById('filterWallet');
  // reset
  opSel.innerHTML = '<option value="">(todos)</option>';
  walSel.innerHTML = '<option value="">(todas)</option>';
  ops.forEach(o=> {
    const opt = document.createElement('option'); opt.value=o; opt.textContent=o; opSel.appendChild(opt);
  });
  wallets.forEach(w=> {
    const opt = document.createElement('option'); opt.value=w; opt.textContent=w; walSel.appendChild(opt);
  });
  document.getElementById('detOps').textContent = ops.size || '-';
  document.getElementById('detWallets').textContent = wallets.size || '-';
}

function renderResults(){
  const container = document.getElementById('resultsArea');
  const opFilter = document.getElementById('filterOperator').value;
  const walFilter = document.getElementById('filterWallet').value;
  const typeFilter = document.getElementById('filterType').value;
  const matchFilter = document.getElementById('filterMatch').value;

  let rows = matchResults.slice();

  rows = rows.filter(row=>{
    // operator/billetera filter -> if chunior present, check; if not present but agent present, pass (since operator only in chunior)
    if(opFilter){
      if(row.chunior && row.chunior.operador !== opFilter) return false;
      if(!row.chunior) return false;
    }
    if(walFilter){
      if(row.chunior && row.chunior.billetera !== walFilter) return false;
      if(!row.chunior) return false;
    }
    if(typeFilter !== 'both'){
      // check type: if agent present use its type, else use chunior
      const t = (row.agent ? row.agent.tipo : (row.chunior ? row.chunior.tipo : 'in'));
      if(typeFilter === 'in' && t !== 'in') return false;
      if(typeFilter === 'out' && t !== 'out') return false;
    }
    if(matchFilter !== 'all'){
      if(matchFilter === 'ok' && row.status !== 'ok') return false;
      if(matchFilter === 'missing' && !(row.status === 'missingAgent' || row.status === 'missingChunior')) return false;
      if(matchFilter === 'diff' && row.status !== 'diff') return false;
    }
    return true;
  });

  // build HTML table
  let html = `<table><thead><tr>
    <th>Agente Fecha</th><th>Agente Usuario</th><th>Agente Monto</th>
    <th>Chunior Fecha</th><th>Chunior Usuario</th><th>Chunior Monto</th>
    <th>Operador</th><th>Billetera</th><th>Estado</th>
    </tr></thead><tbody>`;

  for(const r of rows){
    const a = r.agent, c = r.chunior;
    const aDate = a && a.fechaStr ? escapeHtml(a.fechaStr) : '';
    const aUser = a && a.usuario ? escapeHtml(a.usuario) : '';
    const aMonto = a && !isNaN(a.monto) ? fmtMoney(a.monto) : '';
    const cDate = c && c.fechaStr ? escapeHtml(c.fechaStr) : '';
    const cUser = c && c.usuario ? escapeHtml(c.usuario) : '';
    const cMonto = c && !isNaN(c.monto) ? fmtMoney(c.monto) : '';
    const operador = c && c.operador ? escapeHtml(c.operador) : '';
    const billetera = c && c.billetera ? escapeHtml(c.billetera) : '';

    let estadoLabel = '';
    if(r.status === 'ok') estadoLabel = `<span class="ok">✔️ OK</span>`;
    else if(r.status === 'diff') estadoLabel = `<span class="bad">⚠️ Diferencia</span>`;
    else if(r.status === 'missingChunior') estadoLabel = `<span class="bad">❌ Falta en Chunior</span>`;
    else if(r.status === 'missingAgent') estadoLabel = `<span class="bad">❌ Falta en Agente</span>`;
    html += `<tr>
      <td>${aDate}</td><td>${aUser}</td><td>${aMonto}</td>
      <td>${cDate}</td><td>${cUser}</td><td>${cMonto}</td>
      <td>${operador}</td><td>${billetera}</td><td>${estadoLabel}</td>
      </tr>`;
  }
  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ======= Export / Copy ======= */

function escapeCsvField(s){
  if(s === null || s === undefined) return '';
  const str = String(s);
  if(str.indexOf('"') !== -1 || str.indexOf(',') !== -1 || str.indexOf('\n') !== -1){
    return `"${str.replace(/"/g,'""')}"`;
  }
  return str;
}

document.getElementById('btnExportCSV').addEventListener('click', ()=>{
  if(matchResults.length===0) { alert('Ejecutá el matching primero.'); return; }
  // header:
  const header = ['AGENTE_FECHA','AGENTE_USUARIO','AGENTE_MONTO','CHUNIOR_FECHA','CHUNIOR_USUARIO','CHUNIOR_MONTO','OPERADOR','BILLETERA','ESTADO'];
  const rows = [header.join(',')];
  for(const r of matchResults){
    const a = r.agent, c = r.chunior;
    const row = [
      a ? a.fechaStr : '',
      a ? a.usuario : '',
      a ? a.monto : '',
      c ? c.fechaStr : '',
      c ? c.usuario : '',
      c ? c.monto : '',
      c ? c.operador : '',
      c ? c.billetera : '',
      r.status
    ].map(escapeCsvField).join(',');
    rows.push(row);
  }
  const blob = new Blob([rows.join('\r\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'comparacion_agente_chunior.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showMsg('CSV exportado');
});

document.getElementById('btnCopyForExcel').addEventListener('click', ()=>{
  // We will copy rows so that AGENTE_USUARIO ends up in column A and TURNO ends up in column G (7th col).
  // To do that we create comma-separated values with empty fields between A and G: "user,,,,,,turno"
  if(matchResults.length===0){ alert('Ejecutá el matching primero.'); return; }
  const lines = [];
  for(const r of matchResults){
    // choose record to take usuario and date from agent if available otherwise chunior
    const a = r.agent, c = r.chunior;
    const usuario = a ? a.usuario : (c ? c.usuario : '');
    const fecha = a ? a.fechaObj : (c ? c.fechaObj : null);
    const turno = computeTurno(fecha);
    // create a CSV-like line with 7 columns where col A = usuario, col G = turno
    // That means: usuario, "", "", "", "", "", turno
    const row = [usuario,'','','','','',turno].map(escapeCsvField).join(',');
    lines.push(row);
  }
  const text = lines.join('\r\n');
  navigator.clipboard.writeText(text).then(()=> showMsg('Copiado listo — pegá en Google Sheets (col A = usuario, col G = turno)'));
});

/* ======= Helpers & UI ======= */

function showMsg(m){
  // small ephemeral area: use console and toast
  console.log(m);
  const toast = document.getElementById('__simple_toast__');
  if(!toast){
    const t = document.createElement('div');
    t.id='__simple_toast__';
    t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px';
    t.style.background='linear-gradient(90deg,#052b32,#073644)'; t.style.color='#dffefe';
    t.style.padding='10px 12px'; t.style.borderRadius='8px'; t.style.zIndex=9999; t.style.boxShadow='0 10px 30px rgba(2,8,17,0.7)';
    document.body.appendChild(t);
  }
  const el = document.getElementById('__simple_toast__'); el.textContent = m; el.style.opacity = 1;
  setTimeout(()=> el.style.opacity = 0, 1800);
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ======= Entradas rápidas: si arrastran archivo de chunior al textarea, autoparse ====== */
const chuniorText = document.getElementById('chuniorText');
chuniorText.addEventListener('paste', (e)=> {
  // allow paste but not auto parse here
});
document.getElementById('inputAgentFiles').addEventListener('drop', (e)=>{
  // nothing special
});
/* Drag & drop for chunior file into textarea */
document.getElementById('chuniorText').addEventListener('drop', async (e)=>{
  e.preventDefault();
  const f = e.dataTransfer.files[0];
  if(f){
    const txt = await f.text();
    chuniorText.value = txt;
    parseChuniorFromTextarea();
  }
});

/* File -> parse agents on file selection if the user didn't click button */
document.getElementById('inputAgentFiles').addEventListener('change', ()=> {
  if(confirm('¿Parsear ahora los archivos de agente seleccionados? (si cancelás deberás presionar "Parsear Agentes" manualmente)')){
    parseAgentFiles();
  }
});

/* Allow pressing "Ejecutar matching" quickly */
document.getElementById('btnMatch').addEventListener('click', ()=> {
  if(agentRecords.length===0 && chuniorRecords.length===0){ alert('Parseá agentes y chunior antes de ejecutar matching'); return; }
  runMatching();
});

/* keyboard shortcuts: Ctrl+M -> match */
document.addEventListener('keydown', (e)=> { if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='m'){ e.preventDefault(); runMatching(); } });

/* initial sample placeholders (optional) */
// nothing

</script>
</body>
</html>
