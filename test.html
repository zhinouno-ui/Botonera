<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Comparador AGENTE ⇄ CHUNIOR — Herramienta</title>

<style>
  :root{
    --bg:#071227; --card:#0b1722; --muted:#9fb6c7; --accent:#06b6d4;
    --ok:#2ecc71; --bad:#e04747; --glass:rgba(255,255,255,0.03); --text:#e6f7fb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;font-family:Inter,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,#071020,#071827);color:var(--text);padding:18px;
  }
  .wrap{max-width:1500px;margin:0 auto}

  h1{margin:0 0 10px;font-size:22px;font-weight:700}
  .card{
    background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.02));
    padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);
    box-shadow:0 8px 25px rgba(0,0,0,0.55)
  }

  /* Inputs */
  .row{display:flex;gap:12px;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  input[type=file], select{
    background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);color:var(--text)
  }
  textarea{
    width:100%;min-height:140px;background:rgba(255,255,255,0.02);
    border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.05);
    color:var(--text);resize:vertical
  }

  .btn{
    background:linear-gradient(90deg,var(--accent),#3dd9f0);
    padding:10px 14px;border:none;border-radius:8px;cursor:pointer;
    font-weight:700;color:#042a31;
  }
  .btn:active{transform:translateY(1px)}

  /* Icono pantalla completa */
  .fullscreen-icon{
    font-size:15px;cursor:pointer;margin-right:8px;color:#4eeaff;
    opacity:.85;transition:.15s;
  }
  .fullscreen-icon:hover{opacity:1;transform:scale(1.15)}

  /* Tabla */
  .table-wrap{
    margin-top:12px;max-height:600px;overflow:auto;border-radius:8px;
    border:1px solid rgba(255,255,255,0.05);
    background:rgba(255,255,255,0.015)
  }
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{
    padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left
  }
  th{
    position:sticky;top:0;z-index:5;
    background:rgba(0,0,0,0.25);backdrop-filter:blur(3px);
    font-weight:600;color:#dff6fb
  }

  tr.ok td{background:rgba(46,204,113,0.04)}
  tr.miss-agente td{background:rgba(224,71,71,0.04)}
  tr.miss-chunior td{background:rgba(255,190,60,0.04)}

  .state-ok{color:var(--ok);font-weight:700}
  .state-bad{color:var(--bad);font-weight:800}

  .edit-icon{
    font-size:14px;cursor:pointer;margin-left:5px;
    color:#58b6ff;opacity:.8;transition:.2s;
  }
  .edit-icon:hover{opacity:1;transform:scale(1.2)}

  .filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .badge{
    padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);
    color:var(--muted);font-size:14px
  }

</style>
</head>

<body>
<div class="wrap">
  <h1>Comparador AGENTE ⇄ CHUNIOR</h1>

  <div class="card">

    <!-- Inputs principales -->
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Cargar CSV(s) AGENTE / SUBAGENTE (multiarchivo)</label>
        <input id="agentFiles" type="file" multiple accept=".csv"/>
      </div>

      <div style="flex:1;min-width:300px">
        <label>Pegar texto completo CHUNIOR</label>
        <textarea id="chuniorText"></textarea>
      </div>

      <div style="width:220px">
        <label>Acciones</label>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button id="processBtn" class="btn">Procesar</button>
          <button id="exportBtn" class="btn" style="background:linear-gradient(90deg,#d67f00,#f59e0b)">Exportar CSV</button>
          <button id="copyExcelBtn" class="btn">Copiar a Excel</button>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <div class="badge">Registros: <span id="countTotals">0</span></div>

      <div>
        <label>Operador</label>
        <select id="filterOperador"><option value="__ALL">Todos</option></select>
      </div>

      <div>
        <label>Billetera</label>
        <select id="filterBilletera"><option value="__ALL">Todas</option></select>
      </div>

      <div>
        <label>Turno</label>
        <select id="filterTurno">
          <option value="__ALL">Todos</option>
          <option value="TM">Mañana (06-14)</option>
          <option value="TT">Tarde (14-22)</option>
          <option value="TN">Noche (22-06)</option>
        </select>
      </div>

      <div>
        <label>Estado</label>
        <select id="filterEstado">
          <option value="__ALL">Todos</option>
          <option value="OK">OK</option>
          <option value="MISSING_CHUNIOR">Falta CHUNIOR</option>
          <option value="MISSING_AGENT">Falta AGENTE</option>
        </select>
      </div>
    </div>

    <!-- TABLA -->
    <div class="table-wrap" id="tableContainer">

      <table id="resultsTable">
        <thead>
          <tr>
            <!-- ICONO + AGENTE JUNTOS (OPCIÓN B) -->
            <th style="min-width:150px">
              <span id="fullscreenBtn" class="fullscreen-icon">⛶</span>
              Agente
            </th>
            <th>Turno</th>
            <th>Agente Hora</th>
            <th>Agente Usuario</th>
            <th>Agente Monto</th>
            <th>Chunior Hora</th>
            <th>Chunior Usuario</th>
            <th>Chunior Monto</th>
            <th>Operador</th>
            <th>Billetera</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>

    </div>

    <!-- Resumen -->
    <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap;color:var(--muted)">
      <div class="badge">AGENTE: <span id="totAgent">0</span></div>
      <div class="badge">CHUNIOR: <span id="totChunior">0</span></div>
      <div class="badge">OK: <span id="totPaired">0</span></div>
      <div class="badge">Missing: <span id="countMissing">0</span></div>
    </div>

  </div>
</div>

<script>
/* --- UTILIDADES --- */

function readFileAsText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(String(e.target.result||""));
    r.onerror=rej;
    r.readAsText(file,"utf-8");
  });
}

function splitLines(t){
  return t.split(/\r?\n/).map(l=>l.replace(/\uFEFF/g,'')).filter(l=>l.trim()!=="");
}

function parseCSVLine(line){
  const out=[]; let cur="",q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c=='"'){
      if(q && line[i+1]=='"'){cur+='"';i++;continue;}
      q=!q; continue;
    }
    if(c=="," && !q){out.push(cur);cur="";continue;}
    cur+=c;
  }
  out.push(cur);
  return out;
}

function parseAmountRaw(x){
  let s=String(x||"").trim().replace(/[^\d\-,\.]/g,'');
  if(!s) return 0;
  if(s.includes('.') && s.includes(',')) s=s.replace(/\./g,'').replace(/,/g,'.');
  else if(s.includes(',') && !s.includes('.')) s=s.replace(/\./g,'').replace(/,/g,'.');
  else s=s.replace(/,/g,'');
  let n=parseFloat(s);
  return isNaN(n)?0:n;
}

/* --- PARSE CSV AGENTE & SUBAGENTE --- */
function parseAgentLines(lines){
  const rows=[];
  let start=0;

  if(lines[0] && /fecha/i.test(lines[0])) start=1;

  for(let i=start;i<lines.length;i++){
    let cols=parseCSVLine(lines[i]);
    if(cols.length<2) continue;

    let fecha=cols[0]||"";
    let montoRaw=cols[3]||cols[2]||"";
    let usuarioRaw=cols[6]||cols[5]||cols[4]||cols[cols.length-1]||"";

    let monto=parseAmountRaw(montoRaw);
    let usuario=String(usuarioRaw).toLowerCase().trim();

    let fObj=null;
    if(fecha){
      const at=new Date(fecha.replace(' ','T'));
      if(!isNaN(at.getTime())) fObj=at;
    }

    rows.push({
      origen:"AGENT",
      fecha,fechaObj:fObj,monto,usuario,
      agenteArchivo:"" // set later based on filename
    });
  }
  return rows;
}

/* --- PARSE CHUNIOR --- */
function parseChuniorLines(lines){
  const rows=[];
  for(let raw of lines){
    let parts=raw.split(/\s{2,}|\t+/).map(p=>p.trim()).filter(Boolean);
    if(/^\d+$/.test(parts[0])) parts.shift();

    if(/\d{2}-\d{2}-\d{4}/.test(parts[0]) && /^\d{2}:\d{2}:\d{2}$/.test(parts[1])){
      parts[0]=parts[0]+" "+parts[1];
      parts.splice(1,1);
    }

    let fecha=parts[0]||"";
    let operador=(parts[1]||"").toLowerCase();
    let billeteraRaw=parts[2]||"";
    let monto=parseAmountRaw(parts[3]||"");
    let usuario=(parts[4]||parts[parts.length-1]||"").toLowerCase().trim();
    let billetera=billeteraRaw.replace(/.*-\s*/,"").trim().toUpperCase();

    let fObj=null;
    let m=fecha.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}:\d{2}:\d{2})/);
    if(m) fObj=new Date(`${m[3]}-${m[2]}-${m[1]}T${m[4]}`);

    rows.push({
      origen:"CHUNIOR",
      fecha,fechaObj:fObj,monto,usuario,operador,billetera
    });
  }
  return rows;
}

function getTurnoFromDate(d){
  if(!d) return "TN";
  const h=d.getHours();
  if(h>=6&&h<14) return "TM";
  if(h>=14&&h<22) return "TT";
  return "TN";
}

/* --- PROCESAMIENTO PRINCIPAL --- */
document.getElementById("processBtn").addEventListener("click", async ()=>{

  const files=document.getElementById("agentFiles").files;
  let agentRaw=[];

  // leer múltiples CSV
  for(const f of files){
    let txt=await readFileAsText(f);
    let lines=splitLines(txt);
    let rows=parseAgentLines(lines);

    // guardar nombre archivo → agente/subagente
    rows.forEach(r=>r.agenteArchivo=f.name);

    agentRaw = agentRaw.concat(rows);
  }

  const chuniorRaw=parseChuniorLines(splitLines(document.getElementById("chuniorText").value));

  // turnos
  agentRaw.forEach(r=>r.turno=getTurnoFromDate(r.fechaObj));
  chuniorRaw.forEach(r=>r.turno=getTurnoFromDate(r.fechaObj));

  // MATCHING EXACTO usuario+monto
  const used=new Set();
  const pairs=[];

  for(const a of agentRaw){
    let idx=-1;
    for(let i=0;i<chuniorRaw.length;i++){
      const c=chuniorRaw[i];
      if(used.has(i)) continue;
      if(a.usuario===c.usuario && a.monto===c.monto){
        idx=i; break;
      }
    }
    if(idx>=0){
      used.add(idx);
      pairs.push({agente:a,chunior:chuniorRaw[idx],estado:"OK"});
    } else {
      pairs.push({agente:a,chunior:null,estado:"MISSING_CHUNIOR"});
    }
  }

  chuniorRaw.forEach((c,i)=>{
    if(!used.has(i)){
      pairs.push({agente:null,chunior:c,estado:"MISSING_AGENT"});
    }
  });

  window.__COMPARE_PAIRS=pairs;

  fillFilters(chuniorRaw);
  renderTable();

  document.getElementById("totAgent").textContent=agentRaw.length;
  document.getElementById("totChunior").textContent=chuniorRaw.length;
  document.getElementById("totPaired").textContent=pairs.filter(p=>p.estado==="OK").length;
  document.getElementById("countTotals").textContent=pairs.length;
  document.getElementById("countMissing").textContent=pairs.filter(p=>p.estado!=="OK").length;
});

/* --- FILTROS --- */
function fillFilters(ch){
  const ops=[...new Set(ch.map(x=>x.operador).filter(Boolean))].sort();
  const bis=[...new Set(ch.map(x=>x.billetera).filter(Boolean))].sort();

  let opSel=document.getElementById("filterOperador");
  opSel.innerHTML='<option value="__ALL">Todos</option>';
  ops.forEach(o=>{
    let x=document.createElement("option");
    x.value=o; x.textContent=o;
    opSel.appendChild(x);
  });

  let biSel=document.getElementById("filterBilletera");
  biSel.innerHTML='<option value="__ALL">Todas</option>';
  bis.forEach(b=>{
    let x=document.createElement("option");
    x.value=b; x.textContent=b;
    biSel.appendChild(x);
  });
}

["filterOperador","filterBilletera","filterTurno","filterEstado"].forEach(id=>{
  document.getElementById(id).addEventListener("change",renderTable);
});

/* --- RENDER TABLA --- */
function renderTable(){
  const tbody=document.getElementById("resultsBody");
  const pairs=window.__COMPARE_PAIRS||[];
  tbody.innerHTML="";

  const fo=document.getElementById("filterOperador").value;
  const fb=document.getElementById("filterBilletera").value;
  const ft=document.getElementById("filterTurno").value;
  const fe=document.getElementById("filterEstado").value;

  let visible=0;

  for(const p of pairs){
    const a=p.agente, c=p.chunior;

    if(fo!=="__ALL" && (!c || c.operador!==fo)) continue;
    if(fb!=="__ALL" && (!c || c.billetera!==fb)) continue;

    const turno=(a?a.turno:(c?c.turno:""));
    if(ft!=="__ALL" && turno!==ft) continue;

    if(fe!=="__ALL" && p.estado!==fe) continue;

    let tr=document.createElement("tr");
    tr.className= p.estado==="OK" ? "ok" :
                  p.estado==="MISSING_CHUNIOR" ? "miss-chunior" : "miss-agente";

    tr.innerHTML=`
      <td>${a?a.agenteArchivo:""} <span class="edit-icon">✎</span></td>
      <td>${turno}</td>
      <td>${a?.fechaObj? a.fechaObj.toLocaleTimeString() : ""}</td>
      <td>${a?.usuario||""}</td>
      <td>$ ${a?.monto?.toLocaleString("es-AR",{minimumFractionDigits:2})||""}</td>

      <td>${c?.fechaObj? c.fechaObj.toLocaleTimeString() : ""}</td>
      <td>${c?.usuario||""}</td>
      <td>$ ${c?.monto?.toLocaleString("es-AR",{minimumFractionDigits:2})||""}</td>

      <td>${c?.operador||""}</td>
      <td>${c?.billetera||""}</td>

      <td>
        ${p.estado==="OK"
          ? '<span class="state-ok">✔ OK</span>'
          : '<span class="state-bad">❌</span>'}
      </td>
    `;
    tbody.appendChild(tr);
    visible++;
  }

  document.getElementById("countTotals").textContent=visible;
}

/* --- FULLSCREEN --- */
document.getElementById("fullscreenBtn").addEventListener("click",()=>{
  let el=document.documentElement;
  if(!document.fullscreenElement) el.requestFullscreen();
  else document.exitFullscreen();
});

/* --- EXPORT CSV --- */
document.getElementById("exportBtn").addEventListener("click",()=>{
  const pairs=window.__COMPARE_PAIRS||[];
  if(!pairs.length) return alert("Nada para exportar.");

  const headers=[
    "AgenteArchivo","Turno","AgenteHora","AgenteUsuario","AgenteMonto",
    "ChuniorHora","ChuniorUsuario","ChuniorMonto","Operador","Billetera","Estado"
  ];

  let out=[headers.join(",")];

  for(const p of pairs){
    const a=p.agente, c=p.chunior;

    out.push([
      a?.agenteArchivo||"",
      (a?.turno||c?.turno||""),
      a?.fechaObj? a.fechaObj.toISOString():"",
      a?.usuario||"",
      a?.monto||"",

      c?.fechaObj? c.fechaObj.toISOString():"",
      c?.usuario||"",
      c?.monto||"",

      c?.operador||"",
      c?.billetera||"",
      p.estado
    ].join(","));
  }

  let blob=new Blob([out.join("\n")],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");

  a.href=url; a.download="comparacion.csv"; a.click();
  URL.revokeObjectURL(url);
});

/* --- COPIAR PARA EXCEL --- */
document.getElementById("copyExcelBtn").addEventListener("click",()=>{
  const pairs=window.__COMPARE_PAIRS||[];
  let lines=[];
  lines.push("Agente\tTurno\tA_Hora\tA_Usuario\tA_Monto\tC_Hora\tC_Usuario\tC_Monto\tOperador\tBilletera\tEstado");

  for(const p of pairs){
    const a=p.agente, c=p.chunior;
    lines.push([
      a?.agenteArchivo||"",
      (a?.turno||c?.turno||""),
      a?.fechaObj? a.fechaObj.toLocaleString():"",
      a?.usuario||"",
      a?.monto||"",

      c?.fechaObj? c.fechaObj.toLocaleString():"",
      c?.usuario||"",
      c?.monto||"",

      c?.operador||"",
      c?.billetera||"",
      p.estado
    ].join("\t"));
  }

  navigator.clipboard.writeText(lines.join("\n"))
  .then(()=>alert("Copiado — pegalo en Google Sheets."))
  .catch(()=>alert("Error copiando"));
});

</script>
</body>
</html>
