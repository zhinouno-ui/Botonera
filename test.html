<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Comparador AGENTE ⇄ CHUNIOR — Herramienta</title>
<style>
  :root{
    --bg:#071227; --card:#0b1722; --muted:#9fb6c7; --accent:#06b6d4; --ok:#2ecc71; --bad:#e04747;
    --glass: rgba(255,255,255,0.03);
    --text:#e6f7fb;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071020,#071827);color:var(--text);padding:18px;}
  .wrap{max-width:1200px;margin:0 auto}
  h1{margin:0 0 8px 0;font-size:20px}
  .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(0,0,0,0.5)}
  .row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=file]{background:var(--glass);padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
  textarea{width:100%;min-height:140px;background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.03);color:var(--text);resize:vertical}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),#3dd9f0);color:#042a31;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .small{padding:8px 10px;font-size:13px}
  .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  select{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);color:var(--text)}
  .summary{display:flex;gap:12px;align-items:center;margin-top:12px;color:var(--muted);font-size:14px}
  .table-wrap{margin-top:12px;max-height:520px;overflow:auto;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;vertical-align:middle}
  th{position:sticky;top:0;background:rgba(0,0,0,0.18);z-index:3;color:#dff6fb}
  tr.ok td{background:rgba(46,204,113,0.04)}
  tr.miss-agente td{background:rgba(224,71,71,0.04)}
  tr.miss-chunior td{background:rgba(255,190,60,0.04)}
  .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
  .state-ok{color:var(--ok);font-weight:700}
  .state-bad{color:var(--bad);font-weight:800}
  .controls-vertical{display:flex;flex-direction:column;gap:8px}
  .notes{margin-top:10px;color:var(--muted);font-size:13px}
  @media (max-width:920px){ .row{flex-direction:column} .filters{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Comparador AGENTE ⇄ CHUNIOR</h1>
  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:280px">
        <label>Cargar CSV(s) AGENTE (puedes seleccionar varios)</label>
        <input id="agentFiles" type="file" accept=".csv" multiple />
        <div class="notes">Formato esperado: CSV exportado por la plataforma. Se detecta Fecha (col 0), Cantidad (col 3) y Alias del jugador (col 6) cuando existe; si no, se intenta inferir.</div>
      </div>

      <div style="flex:1;min-width:300px">
        <label>Pegar texto CHUNIOR (todo el día / turno, varias líneas)</label>
        <textarea id="chuniorText" placeholder="Pega aquí las líneas copiadas de Chunior..."></textarea>
        <div class="notes">Ejemplo de línea Chunior: <code>7007867    10-11-2025 13:48:45    fyeivan    682 - LUNA    $ 3.000,00    clau3628</code></div>
      </div>

      <div style="width:220px">
        <label>Acciones</label>
        <div class="controls-vertical">
          <button id="processBtn" class="btn small">Procesar y emparejar</button>
          <button id="exportBtn" class="small btn" style="background:linear-gradient(90deg,#f59e0b,#f97316)">Exportar CSV</button>
          <button id="copyExcelBtn" class="small btn" style="background:linear-gradient(90deg,#06b6d4,#3dd9f0)">Copiar para Excel</button>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="badge">Detectados: <span id="countTotals">0 registros</span></div>
      <div><label>Operador</label><select id="filterOperador"><option value="__ALL">Todos</option></select></div>
      <div><label>Billetera</label><select id="filterBilletera"><option value="__ALL">Todas</option></select></div>
      <div><label>Turno</label><select id="filterTurno"><option value="__ALL">Todos</option><option value="TM">Mañana (06-14)</option><option value="TT">Tarde (14-22)</option><option value="TN">Noche (22-06)</option></select></div>
      <div><label>Estado</label><select id="filterEstado"><option value="__ALL">Todos</option><option value="OK">OK</option><option value="MISSING_CHUNIOR">Falta en CHUNIOR</option><option value="MISSING_AGENT">Falta en AGENTE</option></select></div>
      <div style="margin-left:auto" class="badge">Paired: <span id="countPaired">0</span> · Missing: <span id="countMissing">0</span></div>
    </div>

    <div id="tableContainer" class="table-wrap" aria-live="polite" style="margin-top:12px">
      <table id="resultsTable" role="table">
        <thead>
          <tr>
            <th style="min-width:70px">Turno</th>
            <th style="min-width:120px">Agente hora</th>
            <th>Agente usuario</th>
            <th style="min-width:90px">Agente monto</th>
            <th style="min-width:120px">Chunior hora</th>
            <th>Chunior usuario</th>
            <th style="min-width:90px">Chunior monto</th>
            <th style="min-width:120px">Operador</th>
            <th style="min-width:120px">Billetera</th>
            <th style="min-width:80px">Estado</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div class="summary" id="summaryBox" style="margin-top:12px">
      <div class="badge">Registros AGENTE: <span id="totAgent">0</span></div>
      <div class="badge">Registros CHUNIOR: <span id="totChunior">0</span></div>
      <div class="badge">Emparejados: <span id="totPaired">0</span></div>
    </div>

    <div class="notes" style="margin-top:12px">
      • Matching exacto por <strong>usuario normalizado (minúsc)</strong> y <strong>monto</strong> — cualquier diferencia marca discrepancia.<br>
      • Turnos: Mañana 06:00–14:00, Tarde 14:00–22:00, Noche 22:00–06:00.
    </div>
  </div>
</div>

<script>
/* UTIL: lectura CSV robusta (returns array of lines without header if detected) */
function readFileAsText(file){
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => res(String(e.target.result || ''));
    r.onerror = rej;
    r.readAsText(file, 'utf-8');
  });
}
function splitLines(text){
  return text.split(/\r?\n/).map(l => l.replace(/\uFEFF/g,'')).filter(l => l.trim() !== '');
}
/* parse CSV line with quotes */
function parseCSVLine(line){
  const out = [];
  let cur = '', inQuotes=false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"' ) {
      if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes; continue;
    }
    if (ch === ',' && !inQuotes){ out.push(cur); cur=''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* CLEAN amount strings:
   AGENT CSV likely "4000" or "4.000,00" or "4000.00" => normalize to Number (float)
   CHUNIOR sample: "$ 3.000,00" => remove $, spaces, convert
*/
function parseAmountRaw(raw){
  if(raw === null || raw === undefined) return 0;
  let s = String(raw).trim();
  if(!s) return 0;
  // remove currency signs
  s = s.replace(/[^\d\-,\.]/g, '');
  // detect patterns: if contains both '.' and ',' and ',' appears at end -> treat '.' thousands, ',' decimals
  // else if contains '.' and no ',' -> assume '.' decimal (en-US)
  // else if contains ',' and no '.' -> assume ',' decimal (arg style)
  if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1){
    // assume '.' thousands, ',' decimals -> remove dots, replace comma with dot
    s = s.replace(/\./g, '').replace(/,/g, '.');
  } else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1){
    // assume comma decimal
    s = s.replace(/\./g,'').replace(/,/g,'.');
  } else {
    // pure digits or dot decimal
    s = s.replace(/,/g,''); // remove stray commas
  }
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

/* parse agent CSV rows array (lines)
   We attempt to detect header. Expected columns:
   Fecha (0), Tipo?, Estado?, Cantidad (3), Balance, Alias agente, Alias jugador (6)
*/
function parseAgentLines(lines){
  const rows = [];
  let startIndex = 0;
  // try detect header row that contains 'Fecha' or 'Cantidad' etc
  if(lines.length === 0) return rows;
  if (/fecha/i.test(lines[0]) || /cantidad/i.test(lines[0]) || /alias/i.test(lines[0])){
    startIndex = 1;
  }
  for (let i=startIndex;i<lines.length;i++){
    const line = lines[i];
    if(!line.trim()) continue;
    const cols = parseCSVLine(line);
    // obtain fecha
    const fechaRaw = (cols[0]||'').trim();
    let montoRaw = (cols[3] !== undefined ? cols[3] : cols[2] || '');
    let usuarioRaw = (cols[6] || cols[5] || cols[4] || '').trim();
    // if alias maybe in another col, fallback to last column
    if(!usuarioRaw && cols.length>0) usuarioRaw = cols[cols.length-1].trim();
    const monto = parseAmountRaw(montoRaw);
    const usuario = usuarioRaw ? String(usuarioRaw).toLowerCase().trim() : '';
    // parse fecha to Date object if possible
    let fechaObj = null;
    if(fechaRaw){
      const attempt = new Date(fechaRaw.replace(' ', 'T'));
      fechaObj = isNaN(attempt.getTime()) ? new Date(fechaRaw) : attempt;
      if(isNaN(fechaObj.getTime())) fechaObj = null;
    }
    rows.push({ origen:'AGENT', fecha: fechaRaw, fechaObj, monto, usuario });
  }
  return rows;
}

/* parse chunior pasted text.
   Example line:
   7007867    10-11-2025 13:48:45    fyeivan    682 - LUNA    $ 3.000,00    clau3628
   We split by tabs or 2+ spaces.
*/
function parseChuniorLines(lines){
  const rows = [];
  for (let raw of lines){
    if(!raw.trim()) continue;
    // split by tab or multiple spaces
    let parts = raw.split(/\t+/).map(p => p.trim()).filter(Boolean);
    if(parts.length < 2){
      parts = raw.split(/\s{2,}/).map(p => p.trim()).filter(Boolean);
    }
    // If first token is numeric ID, drop it
    if(parts.length >= 6 && /^\d+$/.test(parts[0])) parts.shift();
    // Now expected: [date-time, operador, billetera-info, monto, usuario]
    // Some variants: date-time may be split in two tokens like '10-11-2025' and '13:48:45'
    if(parts.length >= 5 && /^\d{2}-\d{2}-\d{4}$/.test(parts[0]) && /^\d{2}:\d{2}:\d{2}$/.test(parts[1])){
      // merge
      parts[0] = parts[0] + ' ' + parts[1];
      parts.splice(1,1);
    }
    // now try to assign
    let fechaRaw = parts[0] || '';
    let operador = parts[1] || '';
    let billeteraRaw = parts[2] || '';
    let montoRaw = parts[3] || '';
    let usuarioRaw = parts[4] || parts[parts.length-1] || '';
    // clean billetera (e.g., '682 - LUNA' => 'LUNA')
    let billetera = billeteraRaw.replace(/.*-\s*/,'').trim();
    if(!billetera) billetera = billeteraRaw.trim();
    const monto = parseAmountRaw(montoRaw);
    const usuario = usuarioRaw ? String(usuarioRaw).toLowerCase().trim() : '';
    // parse date
    let fechaObj = null;
    if(fechaRaw){
      // try dd-mm-yyyy hh:mm:ss -> convert to yyyy-mm-ddThh:mm:ss
      const m = fechaRaw.match(/(\d{2})-(\d{2})-(\d{4})\s+(\d{2}:\d{2}:\d{2})/);
      if(m){
        fechaObj = new Date(`${m[3]}-${m[2]}-${m[1]}T${m[4]}`);
      } else {
        const attempt = new Date(fechaRaw.replace(' ', 'T'));
        fechaObj = isNaN(attempt.getTime()) ? null : attempt;
      }
    }
    rows.push({ origen:'CHUNIOR', fecha: fechaRaw, fechaObj, monto, usuario, operador: operador.toLowerCase().trim(), billetera: billetera.toUpperCase().trim() });
  }
  return rows;
}

/* turno calculation */
function getTurnoFromDate(d){
  if(!d || isNaN(d.getTime())) return 'TN';
  const h = d.getHours();
  if(h >= 6 && h < 14) return 'TM';
  if(h >= 14 && h < 22) return 'TT';
  return 'TN';
}

/* MAIN processing */
document.getElementById('processBtn').addEventListener('click', async ()=>{
  const inputFiles = document.getElementById('agentFiles').files;
  const chuniorText = document.getElementById('chuniorText').value || '';
  const resultsBody = document.getElementById('resultsBody');
  resultsBody.innerHTML = '';

  // read all agent files
  let agentLines = [];
  if(inputFiles && inputFiles.length){
    try{
      for(const f of inputFiles){
        const txt = await readFileAsText(f);
        const lines = splitLines(txt);
        agentLines = agentLines.concat(lines);
      }
    } catch(e){
      alert('Error leyendo archivos: ' + (e && e.message ? e.message : e));
      return;
    }
  }

  // parse
  const agentRows = parseAgentLines(agentLines);
  const chuniorLines = splitLines(chuniorText);
  const chuniorRows = parseChuniorLines(chuniorLines);

  // enhance with turno
  agentRows.forEach(r => {
    r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : 'TN';
  });
  chuniorRows.forEach(r => {
    r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : 'TN';
  });

  // matching exact: for each AGENT record find first unmatched CHUNIOR where usuario==usuario && monto==monto
  const matchedChuniorIdx = new Set();
  const pairs = [];
  for (let i=0;i<agentRows.length;i++){
    const a = agentRows[i];
    let matchedIndex = -1;
    for (let j=0;j<chuniorRows.length;j++){
      if(matchedChuniorIdx.has(j)) continue;
      const c = chuniorRows[j];
      if(!a.usuario || !c.usuario) continue;
      if(a.usuario === c.usuario && Math.abs((a.monto||0) - (c.monto||0)) === 0){
        matchedIndex = j; break;
      }
    }
    if(matchedIndex >= 0){
      matchedChuniorIdx.add(matchedIndex);
      pairs.push({ agente: a, chunior: chuniorRows[matchedIndex], estado: 'OK' });
    } else {
      pairs.push({ agente: a, chunior: null, estado: 'MISSING_CHUNIOR' });
    }
  }
  // any chunior left unmatched -> missing agent
  for (let j=0;j<chuniorRows.length;j++){
    if(!matchedChuniorIdx.has(j)){
      pairs.push({ agente: null, chunior: chuniorRows[j], estado: 'MISSING_AGENT' });
    }
  }

  // populate filter selects: operadores / billeteras
  const operadores = new Set(), billeteras = new Set();
  chuniorRows.forEach(r => { if(r.operador) operadores.add(r.operador); if(r.billetera) billeteras.add(r.billetera); });

  const opSel = document.getElementById('filterOperador');
  opSel.innerHTML = '<option value="__ALL">Todos</option>';
  Array.from(operadores).sort().forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; opSel.appendChild(opt); });
  const biSel = document.getElementById('filterBilletera');
  biSel.innerHTML = '<option value="__ALL">Todas</option>';
  Array.from(billeteras).sort().forEach(b => { const opt = document.createElement('option'); opt.value = b; opt.textContent = b; biSel.appendChild(opt); });

  // store global arrays for filtering/export
  window.__COMPARE_PAIRS = pairs;

  // render
  renderTable();
  // update counts
  document.getElementById('totAgent').textContent = agentRows.length;
  document.getElementById('totChunior').textContent = chuniorRows.length;
  document.getElementById('totPaired').textContent = pairs.filter(p=>p.estado==='OK').length;
  document.getElementById('countTotals').textContent = `${pairs.length} filas (incluye unmatched)`;
  document.getElementById('countPaired').textContent = pairs.filter(p=>p.estado==='OK').length;
  document.getElementById('countMissing').textContent = pairs.filter(p=>p.estado !== 'OK').length;
});

/* render table with filters */
function renderTable(){
  const pairs = window.__COMPARE_PAIRS || [];
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  const opFilter = document.getElementById('filterOperador').value;
  const biFilter = document.getElementById('filterBilletera').value;
  const turnoFilter = document.getElementById('filterTurno').value;
  const estadoFilter = document.getElementById('filterEstado').value;

  let shown = 0;
  for(const p of pairs){
    const a = p.agente;
    const c = p.chunior;
    // apply filters: operador / billetera / turno / estado
    if(opFilter !== '__ALL' && (!c || c.operador !== opFilter)) continue;
    if(biFilter !== '__ALL' && (!c || c.billetera !== biFilter)) continue;
    if(turnoFilter !== '__ALL'){
      const t = (a && a.turno) || (c && c.turno) || 'TN';
      if(t !== turnoFilter) continue;
    }
    if(estadoFilter !== '__ALL' && p.estado !== estadoFilter) continue;

    const tr = document.createElement('tr');
    tr.className = p.estado === 'OK' ? 'ok' : (p.estado === 'MISSING_CHUNIOR' ? 'miss-chunior' : 'miss-agente');

    const turno = (a && a.turno) || (c && c.turno) || '';
    const agenteHora = a && a.fechaObj ? formatTime(a.fechaObj) : (a && a.fecha) || '';
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteMonto = a ? (a.monto ? a.monto.toFixed(2) : '0.00') : '';
    const chuniorHora = c && c.fechaObj ? formatTime(c.fechaObj) : (c && c.fecha) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c ? (c.monto ? c.monto.toFixed(2) : '0.00') : '';
    const operador = c && c.operador ? c.operador : '';
    const billetera = c && c.billetera ? c.billetera : '';

    tr.innerHTML = `
      <td>${turno}</td>
      <td>${escapeHtml(agenteHora)}</td>
      <td>${escapeHtml(agenteUsuario)}</td>
      <td>$ ${agenteMonto}</td>
      <td>${escapeHtml(chuniorHora)}</td>
      <td>${escapeHtml(chuniorUsuario)}</td>
      <td>$ ${chuniorMonto}</td>
      <td>${escapeHtml(operador)}</td>
      <td>${escapeHtml(billetera)}</td>
      <td>${p.estado === 'OK' ? '<span class="state-ok">✔ OK</span>' : (p.estado === 'MISSING_CHUNIOR' ? '<span class="state-bad">❌ Falta CH</span>' : '<span class="state-bad">❌ Falta AG</span>')}</td>
    `;
    tbody.appendChild(tr);
    shown++;
  }
  document.getElementById('countTotals').textContent = `${shown} filas visibles`;
}

/* helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function formatTime(d){ if(!d) return ''; try{ return d.toLocaleString(); }catch(e){return '';} }

/* filters change */
['filterOperador','filterBilletera','filterTurno','filterEstado'].forEach(id=>{
  document.getElementById(id).addEventListener('change', renderTable);
});

/* EXPORT CSV */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const pairs = window.__COMPARE_PAIRS || [];
  if(!pairs.length){ alert('No hay datos para exportar.'); return; }
  // build CSV header
  const headers = ['AGENTE_HORA','AGENTE_USUARIO','AGENTE_MONTO','CHUNIOR_HORA','CHUNIOR_USUARIO','CHUNIOR_MONTO','OPERADOR','BILLETERA','ESTADO','TURNO'];
  const rows = [headers.join(',')];
  for(const p of pairs){
    const a = p.agente;
    const c = p.chunior;
    const agenteHora = a && a.fechaObj ? a.fechaObj.toISOString() : (a && csvSafe(a.fecha)) || '';
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteMonto = a && a.monto ? a.monto.toFixed(2) : '';
    const chuniorHora = c && c.fechaObj ? c.fechaObj.toISOString() : (c && csvSafe(c.fecha)) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c && c.monto ? c.monto.toFixed(2) : '';
    const operador = c && c.operador ? c.operador : '';
    const billetera = c && c.billetera ? c.billetera : '';
    const estado = p.estado;
    const turno = (a && a.turno) || (c && c.turno) || '';
    const row = [csvSafe(agenteHora), csvSafe(agenteUsuario), csvSafe(agenteMonto), csvSafe(chuniorHora), csvSafe(chuniorUsuario), csvSafe(chuniorMonto), csvSafe(operador), csvSafe(billetera), csvSafe(estado), csvSafe(turno)].join(',');
    rows.push(row);
  }
  const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `comparacion_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

function csvSafe(v){
  if(v === null || v === undefined) return '';
  let s = String(v).replace(/"/g,'""');
  if(s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) s = `"${s}"`;
  return s;
}

/* Copy for Excel: builds simple two-column-ish paste with AGENTE user in col A and TURNO in col G? 
   The user requested earlier a specialized copy — here we copy rows as TSV so you can paste into Sheets nicely.
   We'll export columns: AGENTE_USUARIO (col A), AGENTE_HORA (col B), AGENTE_MONTO (col C), TURNO (col D), CHUNIOR_USUARIO (col E), CHUNIOR_MONTO (col F), OPERADOR (col G), BILLETERA (col H), ESTADO (col I)
*/
document.getElementById('copyExcelBtn').addEventListener('click', async ()=>{
  const pairs = window.__COMPARE_PAIRS || [];
  if(!pairs.length){ alert('No hay datos para copiar'); return; }
  const lines = [];
  // header
  lines.push(['AGENTE_USUARIO','AGENTE_HORA','AGENTE_MONTO','TURNO','CHUNIOR_USUARIO','CHUNIOR_MONTO','OPERADOR','BILLETERA','ESTADO'].join('\t'));
  for(const p of pairs){
    const a = p.agente, c = p.chunior;
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteHora = a && a.fechaObj ? a.fechaObj.toLocaleString() : (a && a.fecha) || '';
    const agenteMonto = a && a.monto ? a.monto.toFixed(2) : '';
    const turno = (a && a.turno) || (c && c.turno) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c && c.monto ? c.monto.toFixed(2) : '';
    const operador = c && c.operador ? c.operador : '';
    const billetera = c && c.billetera ? c.billetera : '';
    const estado = p.estado;
    const row = [agenteUsuario, agenteHora, agenteMonto, turno, chuniorUsuario, chuniorMonto, operador, billetera, estado].join('\t');
    lines.push(row);
  }
  const tsv = lines.join('\n');
  try{
    await navigator.clipboard.writeText(tsv);
    alert('Copiado al portapapeles como TSV — pegalo en Google Sheets (Archivo > Pegar)');
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = tsv;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert('Copiado (fallback). Pega en Sheets.');
  }
});

/* small utility: re-render when stored pairs updated (if needed) */
window.reRenderCompare = renderTable;
</script>
</body>
</html>
