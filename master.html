<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChinMaker — Editor Maestro</title>
<!-- Minimal reset + variables -->
<style>
:root{
  --bg:#050511; --card:#0f1220; --card-2:#0b0f1a;
  --muted:#98a3b3; --text:#eaf6ff;
  --accent:#8A2BE2; --accent-2:#a855f7;
  --ok:#10B981; --bad:#EF4444;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --shadow: 0 12px 40px rgba(2,6,23,0.6);
}

/* Basic layout */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:
  radial-gradient(circle at 10% 10%, rgba(138,43,226,0.06), transparent 15%),
  radial-gradient(circle at 90% 90%, rgba(16,185,129,0.03), transparent 15%),
  var(--bg); color:var(--text); padding:18px;
}
.wrap{max-width:1300px;margin:0 auto;}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
.title{font-weight:800;font-size:20px;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{color:var(--muted);font-size:13px}

/* Layout grid */
.layout{display:grid;grid-template-columns:1fr 420px;gap:16px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}

/* Cards */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.03);}
.card h2{margin:0 0 8px;font-size:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.col{flex:1;min-width:140px}

/* Inputs */
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text], textarea, select{
  width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text);
}
textarea{min-height:80px;resize:vertical}

/* Buttons */
.btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
.btn.warn{background:linear-gradient(90deg,#f97316,#f59e0b)}

/* Wallet list */
.wallet-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.wallet-card{display:grid;grid-template-columns:28px 1fr 110px;gap:8px;align-items:center;padding:10px;border-radius:10px;background:var(--card-2);border:1px solid rgba(255,255,255,0.03)}
.wallet-card .label{font-weight:700}
.drag-handle{width:22px;height:36px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); cursor:grab; display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
.wallet-actions{display:flex;gap:6px;align-items:center;justify-content:flex-end}

/* Preview */
.preview{position:relative}
.preview-head{display:flex;justify-content:space-between; align-items:center; margin-bottom:8px}
.preview-area{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:12px;border-radius:10px; min-height:120px; border:1px solid rgba(255,255,255,0.03)}
.preview-controls{display:flex;gap:8px;align-items:center}

/* Search */
.search{display:flex;gap:8px;align-items:center}
.search input{padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02)}

/* Modal */
.modal-back{position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.55),rgba(0,0,0,0.6));display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:760px;max-width:94%;background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}

/* Tiny UI details */
.badge{padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-weight:700;font-size:12px}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) translateY(14px);background:rgba(8,10,14,0.9);color:var(--text);padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:all .18s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.kv{font-size:12px;color:var(--muted)}

/* small helpers */
.flex{display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.handle-dots{width:14px;height:32px;border-radius:8px;background:
 radial-gradient(circle at 3px 4px,#6b6f7a 1px,transparent 0),
 radial-gradient(circle at 3px 12px,#6b6f7a 1px,transparent 0),
 radial-gradient(circle at 3px 20px,#6b6f7a 1px,transparent 0),
 radial-gradient(circle at 9px 4px,#6b6f7a 1px,transparent 0),
 radial-gradient(circle at 9px 12px,#6b6f7a 1px,transparent 0),
 radial-gradient(circle at 9px 20px,#6b6f7a 1px,transparent 0);
 cursor:grab}
.fullscreen{position:fixed;inset:10px;background:var(--bg);z-index:80;padding:22px;border-radius:12px;display:none;flex-direction:column}
.fullscreen.show{display:flex;border:1px solid rgba(255,255,255,0.03)}
.small-muted{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="title">ChinMaker • Editor Maestro</div>
      <div class="subtitle small">Perfiles, billeteras, secciones y export para ChinPlantilla</div>
    </div>
    <div class="flex">
      <div id="statusChip" class="badge small">Sin perfil activo</div>
      <button id="btnExport" class="btn">Exportar .chin.json</button>
      <button id="btnImport" class="btn ghost">Importar .chin.json</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Editor -->
    <div>
      <div class="card">
        <h2>Perfiles (Control Maestro)</h2>
        <div class="row">
          <select id="profileSelect"></select>
          <div class="flex">
            <button id="btnNewProfile" class="btn small">Nuevo</button>
            <button id="btnRenameProfile" class="btn ghost small">Renombrar</button>
            <button id="btnResetProfile" class="btn warn small">Reiniciar</button>
          </div>
        </div>
        <p class="small-muted">Al entrar se requiere elegir o crear un perfil. Todo se guarda por perfil en localStorage.</p>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Paleta & Meta</h2>
        <div class="section">
          <div class="row">
            <div class="col">
              <label>Acento</label>
              <input id="inpAccent" type="text" placeholder="#8A2BE2">
            </div>
            <div class="col">
              <label>OK</label>
              <input id="inpOk" type="text" placeholder="#10B981">
            </div>
            <div class="col">
              <label>Error</label>
              <input id="inpBad" type="text" placeholder="#EF4444">
            </div>
          </div>
          <div class="row" style="margin-top:10px;align-items:center">
            <div class="col">
              <label>Nombre del perfil (meta)</label>
              <input id="metaName" type="text" placeholder="PC01">
            </div>
            <div style="width:120px">
              <label>Fecha export</label>
              <input id="metaDate" type="text" readonly>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Billeteras</h2>
        <div class="row" style="align-items:center">
          <div class="col search">
            <input id="walletSearch" placeholder="Buscar billeteras (nombre, alias, titular)" />
          </div>
          <div class="flex">
            <button id="btnAddWallet" class="btn small">+ Añadir</button>
            <button id="btnImportWallets" class="btn ghost small">Importar masiva</button>
            <button id="btnDuplicate" class="btn ghost small">Duplicar</button>
          </div>
        </div>

        <div class="wallet-list" id="walletList"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Secciones & Botones</h2>
        <div class="row">
          <div class="col">
            <label>Agregar sección</label>
            <input id="sectionNewName" placeholder="Ej.: Promo Amigo">
          </div>
          <div style="width:170px">
            <label>&nbsp;</label>
            <div class="flex">
              <button id="btnAddSection" class="btn small">Agregar</button>
            </div>
          </div>
        </div>
        <div id="sectionsList" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Revinculación / WhatsApp</h2>
        <div class="row">
          <div class="col">
            <label>Números WhatsApp (coma separado)</label>
            <input id="waNumbers" placeholder="54911..., 54911..." />
          </div>
          <div class="col">
            <label>Mensaje inicio (usa {usuario})</label>
            <input id="waMessage" placeholder="Hola soy {usuario} ..." />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Saludos (gestión ilimitada)</label>
          <div id="revContainer"></div>
          <div style="margin-top:8px" class="flex">
            <input id="revAddText" placeholder="Escribe saludo y pulsa Añadir" />
            <button id="btnAddRev" class="btn small">Añadir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Preview -->
    <div>
      <div class="card preview">
        <div class="preview-head">
          <div>
            <div style="font-weight:800">Vista previa</div>
            <div class="small">Simulación interactiva (no copia a portapapeles salvo preview)</div>
          </div>
          <div class="preview-controls">
            <button id="btnFullscreenPreview" class="btn small ghost">Pantalla completa</button>
            <button id="btnClearPreview" class="btn ghost small">Limpiar</button>
          </div>
        </div>

        <div class="preview-area" id="previewArea"></div>

        <div style="margin-top:10px" class="small-muted">Último toast: <span id="lastToastText">-</span></div>

      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small-muted">Resumen</div>
          <div><span id="countWallets" class="kv">0</span> billeteras</div>
        </div>
        <div style="margin-top:10px" class="small-muted">Usá exportar para generar el `.chin.json` que lee ChinPlantilla</div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modalBack" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="modalClose" class="btn ghost">Cerrar</button>
    </div>
  </div>
</div>

<div id="fullscreen" class="fullscreen"></div>

<div id="toast" class="toast">Copiado</div>

<!-- SCRIPT -->
<script>
/* ========= State & storage ========= */
const KEY_PREFIX = 'chinmaker_v1_';
const PROFILE_LIST = KEY_PREFIX + 'profiles';
const LAST_PROFILE = KEY_PREFIX + 'last';

let state = {
  profiles: {},    // profileName -> config
  active: null
};

/* Default config factory */
function defaultConfig(name){
  return {
    perfil: name || 'PC01',
    paleta: { acento:'#8A2BE2', ok:'#10B981', bad:'#EF4444' },
    whatsapp: { numeros: [], mensajeInicio: 'Hola soy {usuario} quiero mi clave y cronograma' },
    revinculacion: { saludos: [] }, // unlimited
    billeteras: [],
    secciones: [ { id:'utilidad', name:'Utilidad', buttons:[] }, { id:'billeteras', name:'Billeteras', buttons:[] } ],
    order: ['utilidad','billeteras'],
    metadata: { created: new Date().toISOString() }
  };
}

/* ---------- Storage helpers ---------- */
function saveAll(){
  try{
    localStorage.setItem(PROFILE_LIST, JSON.stringify(Object.keys(state.profiles)));
    Object.entries(state.profiles).forEach(([k,v]) => localStorage.setItem(KEY_PREFIX + k, JSON.stringify(v)));
    localStorage.setItem(LAST_PROFILE, state.active || '');
    indicateSaved();
  }catch(e){ console.error('saveAll',e); }
}
function loadAll(){
  try{
    const listRaw = localStorage.getItem(PROFILE_LIST);
    const names = listRaw ? JSON.parse(listRaw) : [];
    names.forEach(n=>{
      const raw = localStorage.getItem(KEY_PREFIX + n);
      if(raw) try{ state.profiles[n] = JSON.parse(raw); }catch(e){}
    });
    // fallback: if none, create default
    if(Object.keys(state.profiles).length === 0){
      const name = 'PC01';
      state.profiles[name] = defaultConfig(name);
    }
    // active
    const last = localStorage.getItem(LAST_PROFILE);
    state.active = last && state.profiles[last] ? last : Object.keys(state.profiles)[0];
  }catch(e){ console.error('loadAll', e); }
}

/* ========= UI utilities ========= */
const $ = id => document.getElementById(id);
function showToast(msg, time=1600){
  const t = $('toast'); t.textContent = msg; t.classList.add('show'); $('lastToastText').textContent = msg;
  setTimeout(()=>t.classList.remove('show'), time);
}
function showModal(html){
  $('modalContent').innerHTML = html;
  $('modalBack').style.display = 'flex';
}
function closeModal(){ $('modalBack').style.display = 'none'; $('modalContent').innerHTML = ''; }

/* ========= Initialization ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  loadAll();
  ensureActiveProfile();
  bindTopControls();
  renderProfileSelect();
  renderAllEditor();
  renderPreview();
});

/* ========= Profiles handling ========= */
function ensureActiveProfile(){
  if(!state.active){ state.active = Object.keys(state.profiles)[0]; }
  if(!state.profiles[state.active]){ state.profiles[state.active] = defaultConfig(state.active); }
  updateStatus();
}
function renderProfileSelect(){
  const sel = $('profileSelect'); sel.innerHTML = '';
  Object.keys(state.profiles).forEach(name=>{
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
  });
  sel.value = state.active;
  $('metaName').value = state.active;
}
$('profileSelect').addEventListener('change', e=>{
  state.active = e.target.value;
  ensureActiveProfile();
  renderAllEditor(); renderPreview(); saveAll();
});

/* Top controls */
function bindTopControls(){
  $('btnNewProfile').addEventListener('click', ()=>{
    const name = prompt('Nombre del nuevo perfil (ej: PC02):');
    if(!name) return;
    const n = name.trim();
    if(state.profiles[n]){ alert('Ya existe'); return; }
    state.profiles[n] = defaultConfig(n);
    state.active = n;
    renderProfileSelect(); renderAllEditor(); renderPreview(); saveAll();
    showToast('Perfil creado: ' + n);
  });

  $('btnRenameProfile').addEventListener('click', ()=>{
    const old = state.active;
    const name = prompt('Nuevo nombre de perfil:', old);
    if(!name || name.trim()===old) return;
    const n = name.trim();
    if(state.profiles[n]){ alert('Ya existe'); return; }
    state.profiles[n] = state.profiles[old];
    delete state.profiles[old];
    state.active = n;
    renderProfileSelect(); renderAllEditor(); renderPreview(); saveAll(); showToast('Perfil renombrado');
  });

  $('btnResetProfile').addEventListener('click', ()=>{
    if(!confirm(`Reiniciar perfil ${state.active}? Se perderán los datos de este perfil.`)) return;
    state.profiles[state.active] = defaultConfig(state.active);
    renderAllEditor(); renderPreview(); saveAll(); showToast('Perfil reiniciado');
  });

  $('btnImport').addEventListener('click', ()=> openImportFile());
  $('btnExport').addEventListener('click', ()=> doExport());
  $('btnFullscreenPreview').addEventListener('click', ()=> toggleFullscreenPreview());
  $('modalClose').addEventListener('click', closeModal);
}

/* Import file (profile) */
function openImportFile(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,.chin.json';
  inp.onchange = async e=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const txt = await f.text(); const obj = JSON.parse(txt);
      const name = obj.perfil || prompt('Nombre para perfil importado:', f.name.replace(/\.[^/.]+$/,''));
      if(!name) return;
      state.profiles[name] = normalizeImported(obj);
      state.active = name;
      renderProfileSelect(); renderAllEditor(); renderPreview(); saveAll(); showToast('Perfil importado: ' + name);
    }catch(err){ alert('Archivo inválido'); }
  };
  inp.click();
}

/* Normalize imported data to internal shape */
function normalizeImported(raw){
  const out = defaultConfig(raw.perfil || 'imported');
  try{
    if(raw.paleta) out.paleta = raw.paleta;
    if(raw.whatsapp) out.whatsapp = raw.whatsapp;
    if(raw.revinculacion) out.revinculacion = raw.revinculacion;
    if(Array.isArray(raw.billeteras)) out.billeteras = raw.billeteras;
    if(Array.isArray(raw.secciones)) out.secciones = raw.secciones;
    if(Array.isArray(raw.order)) out.order = raw.order;
  }catch(e){}
  out.metadata = Object.assign(out.metadata || {}, raw.metadata || {});
  return out;
}

/* Export to .chin.json format required (ChinPlantilla) */
function doExport(){
  const cfg = state.profiles[state.active];
  cfg.metadata = cfg.metadata || {};
  cfg.metadata.lastExport = new Date().toISOString();
  cfg.fechaExport = cfg.metadata.lastExport;
  // build export payload matching schema (see schema.md)
  const exportObj = {
    perfil: cfg.perfil,
    fechaExport: cfg.fechaExport,
    paleta: cfg.paleta,
    whatsapp: cfg.whatsapp,
    revinculacion: cfg.revinculacion,
    billeteras: cfg.billeteras.map(b => normalizeWalletForExport(b)),
    secciones: cfg.secciones,
    order: cfg.order,
    metadata: cfg.metadata
  };
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${cfg.perfil || 'perfil'}.chin.json`; a.click(); URL.revokeObjectURL(a.href);
  saveAll();
  showToast('Exportado .chin.json');
}

/* Normalize wallet export: keep minimal clean data for ChinPlantilla */
function normalizeWalletForExport(w){
  return {
    id: w.id || ('w'+(Date.now()+Math.floor(Math.random()*1000))),
    label: w.label || '',
    cbu: w.cbu || '',
    alias: w.alias || '',
    titular: w.titular || '',
    billetera: w.billetera === 'Otro' ? (w.billeteraCustom||'Otro') : (w.billetera||''),
    flip: !!w.flip,
    flipData: w.flip ? {
      cbu: w.cbu2||'', alias: w.alias2||'', titular: w.titular2||'', billetera: (w.billetera2 === 'Otro' ? (w.billetera2Custom||'Otro') : (w.billetera2||''))
    } : null,
    meta: { tags: w.tags || [] }
  };
}

/* ========= Editor renderers ========= */
function renderAllEditor(){
  renderProfileSelect();
  renderPalette();
  renderWalletList();
  renderSections();
  renderRevinculacion();
  updateStatus();
}

/* Palette */
function renderPalette(){
  const cfg = state.profiles[state.active];
  $('inpAccent').value = cfg.paleta.acento || '#8A2BE2';
  $('inpOk').value = cfg.paleta.ok || '#10B981';
  $('inpBad').value = cfg.paleta.bad || '#EF4444';
  $('metaName').value = cfg.perfil || state.active;
  $('metaDate').value = cfg.metadata && cfg.metadata.lastExport ? cfg.metadata.lastExport : '';
  // bind changes
  ['inpAccent','inpOk','inpBad'].forEach(id=>{
    $(id).oninput = (e)=>{
      cfg.paleta = cfg.paleta || {};
      if(id==='inpAccent') cfg.paleta.acento = e.target.value;
      if(id==='inpOk') cfg.paleta.ok = e.target.value;
      if(id==='inpBad') cfg.paleta.bad = e.target.value;
      markDirty(); renderPreview();
    };
  });
  $('metaName').onchange = e=>{
    cfg.perfil = e.target.value; markDirty();
    renderProfileSelect();
  };
}

/* Wallet list render and handlers */
function renderWalletList(filterText){
  const cfg = state.profiles[state.active];
  const list = $('walletList');
  list.innerHTML = '';
  const q = (filterText || $('walletSearch').value || '').toLowerCase();
  cfg.billeteras.forEach((w, idx)=>{
    const text = (w.label+' '+(w.alias||'')+' '+(w.titular||'')).toLowerCase();
    if(q && !text.includes(q)) return;
    const card = document.createElement('div'); card.className='wallet-card'; card.draggable=true; card.dataset.index = idx;
    card.innerHTML = `
      <div class="drag-handle"><div class="handle-dots" title="Arrastrar"></div></div>
      <div>
        <div class="label">${escapeHtml(w.label||'Billetera')}</div>
        <div class="small">${escapeHtml(w.alias||w.cbu||'')}</div>
      </div>
      <div class="wallet-actions">
        <button class="btn small ghost" data-edit="${idx}">Editar</button>
        <button class="btn small" data-dupe="${idx}">Duplicar</button>
        <button class="btn small ghost" data-based="${idx}">Basada</button>
        <button class="btn small" data-remove="${idx}">Eliminar</button>
      </div>
    `;
    list.appendChild(card);

    // handlers
    card.querySelector('[data-edit]').addEventListener('click', ()=> openWalletEditor(idx));
    card.querySelector('[data-dupe]').addEventListener('click', ()=> duplicateWallet(idx));
    card.querySelector('[data-based]').addEventListener('click', ()=> newWalletBasedOn(idx));
    card.querySelector('[data-remove]').addEventListener('click', ()=> { if(confirm('Eliminar?')) { cfg.billeteras.splice(idx,1); markDirty(); renderWalletList(); renderPreview(); }});

    // drag
    card.addEventListener('dragstart', (ev)=> { ev.dataTransfer.setData('text/plain', idx); card.style.opacity=.5;});
    card.addEventListener('dragend', ()=> card.style.opacity=1);
    card.addEventListener('dragover', (ev)=>ev.preventDefault());
    card.addEventListener('drop', (ev)=>{ ev.preventDefault(); const from=Number(ev.dataTransfer.getData('text/plain')); const to=Number(card.dataset.index); if(from===to) return; const a=cfg.billeteras.splice(from,1)[0]; cfg.billeteras.splice(to,0,a); markDirty(); renderWalletList(); renderPreview(); });
  });
  $('countWallets').textContent = String(cfg.billeteras.length);
}

/* Search handler */
$('walletSearch').addEventListener('input', ()=> renderWalletList());

/* Add wallet */
$('btnAddWallet').addEventListener('click', ()=>{
  const cfg = state.profiles[state.active];
  cfg.billeteras.push({ id:'w'+Date.now(), label:'Nueva billetera', cbu:'', alias:'', titular:'', billetera:'Mercado Pago', billeteraCustom:'', flip:false, cbu2:'', alias2:'', titular2:'', billetera2:'Mercado Pago', billetera2Custom:''});
  markDirty(); renderWalletList(); renderPreview();
});

/* Duplicate wallet */
function duplicateWallet(idx){
  const cfg = state.profiles[state.active];
  const src = cfg.billeteras[idx];
  const clone = JSON.parse(JSON.stringify(src)); clone.id = 'w'+Date.now();
  cfg.billeteras.splice(idx+1,0,clone);
  markDirty(); renderWalletList(); renderPreview();
}

/* New based on wallet */
function newWalletBasedOn(idx){
  const cfg = state.profiles[state.active];
  const src = cfg.billeteras[idx];
  const copy = JSON.parse(JSON.stringify(src)); copy.id = 'w'+Date.now(); copy.label = (src.label||'') + ' (copy)';
  cfg.billeteras.push(copy);
  markDirty(); renderWalletList(); renderPreview();
}

/* Wallet editor modal */
function openWalletEditor(idx){
  const cfg = state.profiles[state.active];
  const w = cfg.billeteras[idx];
  const html = `
    <h3>Editar billetera</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Nombre visible</label><input id="m_label" value="${escapeAttr(w.label||'')}" /></div>
      <div><label>Titular</label><input id="m_titular" value="${escapeAttr(w.titular||'')}" /></div>
      <div><label>CBU</label><input id="m_cbu" value="${escapeAttr(w.cbu||'')}" /></div>
      <div><label>Alias</label><input id="m_alias" value="${escapeAttr(w.alias||'')}" /></div>
      <div><label>Billetera</label>
        <select id="m_billetera">
          <option>Mercado Pago</option><option>Ualá</option><option>Brubank</option><option>Otro</option>
        </select>
        <input id="m_billetera_custom" placeholder="Si Otro, indica" style="margin-top:6px;display:none" />
      </div>
      <div>
        <label>Flip (segunda billetera)</label>
        <div style="display:flex;gap:8px">
          <button id="m_flip_on" class="btn small ${w.flip? '' : 'ghost'}">${w.flip? 'ON':'ON'}</button>
          <button id="m_flip_off" class="btn small ghost">${w.flip? 'OFF':'OFF'}</button>
        </div>
      </div>
    </div>
    <div id="m_flip_area" style="margin-top:8px; display:${w.flip? 'block':'none'}">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label>CBU (flip)</label><input id="m_cbu2" value="${escapeAttr(w.cbu2||'')}" /></div>
        <div><label>Alias (flip)</label><input id="m_alias2" value="${escapeAttr(w.alias2||'')}" /></div>
        <div><label>Titular (flip)</label><input id="m_titular2" value="${escapeAttr(w.titular2||'')}" /></div>
        <div><label>Billetera (flip)</label><select id="m_billetera2"><option>Mercado Pago</option><option>Ualá</option><option>Brubank</option><option>Otro</option></select>
        <input id="m_billetera2_custom" placeholder="Si Otro, indica" style="margin-top:6px;display:none" /></div>
      </div>
    </div>
    <div style="margin-top:10px;text-align:right">
      <button id="m_save" class="btn">Guardar</button>
      <button id="m_cancel" class="btn ghost">Cancelar</button>
    </div>
  `;
  showModal(html);
  // fill selects
  $('m_billetera').value = w.billetera || 'Mercado Pago';
  $('m_billetera2').value = w.billetera2 || 'Mercado Pago';
  if(w.billetera==='Otro'){ $('m_billetera_custom').style.display=''; $('m_billetera_custom').value = w.billeteraCustom||''; }
  if(w.billetera2==='Otro'){ $('m_billetera2_custom').style.display=''; $('m_billetera2_custom').value = w.billetera2Custom||''; }

  $('m_billetera').onchange = (e)=> { if(e.target.value==='Otro'){ $('m_billetera_custom').style.display=''; } else { $('m_billetera_custom').style.display='none'; } };
  $('m_billetera2').onchange = (e)=> { if(e.target.value==='Otro'){ $('m_billetera2_custom').style.display=''; } else { $('m_billetera2_custom').style.display='none'; } };
  $('m_flip_on').addEventListener('click', ()=> { $('m_flip_area').style.display='block'; });
  $('m_flip_off').addEventListener('click', ()=> { $('m_flip_area').style.display='none'; });

  $('m_save').addEventListener('click', ()=>{
    w.label = $('m_label').value.trim();
    w.titular = $('m_titular').value.trim();
    w.cbu = $('m_cbu').value.trim();
    w.alias = $('m_alias').value.trim();
    w.billetera = $('m_billetera').value;
    w.billeteraCustom = $('m_billetera_custom').value.trim();
    w.flip = $('m_flip_area').style.display !== 'none';
    w.cbu2 = $('m_cbu2').value.trim();
    w.alias2 = $('m_alias2').value.trim();
    w.titular2 = $('m_titular2').value.trim();
    w.billetera2 = $('m_billetera2').value;
    w.billetera2Custom = $('m_billetera2_custom').value.trim();
    markDirty(); renderWalletList(); renderPreview(); closeModal(); showToast('Billetera guardada');
  });
  $('m_cancel').addEventListener('click', ()=> closeModal());
}

/* ========= Sections & buttons ========= */
function renderSections(){
  const cfg = state.profiles[state.active];
  const container = $('sectionsList'); container.innerHTML = '';
  cfg.secciones.forEach((s, i)=>{
    const div = document.createElement('div'); div.style.marginBottom='8px';
    div.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="handle-dots" style="width:20px;height:28px"></div>
          <strong>${escapeHtml(s.name)}</strong>
          <span class="small" style="margin-left:8px;color:var(--muted)">${s.buttons.length} botones</span>
        </div>
        <div class="flex">
          <button class="btn small ghost" data-edit="${i}">Editar</button>
          <button class="btn small" data-add="${i}">+Botón</button>
          <button class="btn small ghost" data-remove="${i}">Eliminar</button>
        </div>
      </div>
    `;
    container.appendChild(div);
    div.querySelector('[data-edit]').addEventListener('click', ()=> editSection(i));
    div.querySelector('[data-add]').addEventListener('click', ()=> addButtonToSection(i));
    div.querySelector('[data-remove]').addEventListener('click', ()=> { if(confirm('Eliminar sección?')){ cfg.secciones.splice(i,1); markDirty(); renderSections(); }});
  });
}

/* Add new section */
$('btnAddSection').addEventListener('click', ()=>{
  const name = $('sectionNewName').value.trim();
  if(!name){ alert('Nombre requerido'); return; }
  const cfg = state.profiles[state.active];
  cfg.secciones.push({ id: 's_'+Date.now(), name, buttons:[] });
  markDirty(); renderSections(); $('sectionNewName').value=''; renderPreview();
});

/* Edit section */
function editSection(idx){
  const cfg = state.profiles[state.active]; const s = cfg.secciones[idx];
  let html = `<h3>Editar sección: ${escapeHtml(s.name)}</h3>`;
  html += `<label>Nombre</label><input id="sec_name" value="${escapeAttr(s.name)}" />`;
  html += `<div style="margin-top:8px"><label>Orden (arrastra para reordenar en preview)</label><div class="small">Secciones actuales: ${cfg.secciones.map(x=>x.name).join(', ')}</div></div>`;
  html += `<div style="margin-top:8px;text-align:right"><button id="sec_save" class="btn">Guardar</button></div>`;
  showModal(html);
  $('sec_name').oninput = (e)=> s.name = e.target.value;
  $('sec_save').addEventListener('click', ()=> { markDirty(); renderSections(); renderPreview(); closeModal(); });
}

/* Add button to section modal */
function addButtonToSection(idx){
  const cfg = state.profiles[state.active]; const s = cfg.secciones[idx];
  const html = `
    <h3>Agregar botón a ${escapeHtml(s.name)}</h3>
    <label>Nombre visible</label><input id="btn_name" />
    <label>Texto que copia / secundario</label><textarea id="btn_text"></textarea>
    <label>Estilo</label>
    <select id="btn_style"><option value="normal">Normal</option><option value="important">Importante</option><option value="warn">Advertencia</option></select>
    <div style="margin-top:8px;text-align:right"><button id="btn_save" class="btn">Agregar</button></div>
  `;
  showModal(html);
  $('btn_save').addEventListener('click', ()=>{
    const name = $('btn_name').value.trim(); const text = $('btn_text').value.trim(); const style = $('btn_style').value;
    if(!name || !text){ alert('Nombre y texto requeridos'); return; }
    s.buttons.push({ id:'b_'+Date.now(), name, text, style, flip:false });
    markDirty(); renderSections(); renderPreview(); closeModal(); showToast('Botón agregado');
  });
}

/* ========= Revinculación management (unlimited) ========= */
function renderRevinculacion(){
  const cfg = state.profiles[state.active];
  const cont = $('revContainer'); cont.innerHTML = '';
  cfg.revinculacion.saludos.forEach((s, idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='6px';
    row.innerHTML = `<div style="flex:1;border-radius:8px;padding:8px;background:var(--card-2)">${escapeHtml(s)}</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn small ghost" data-edit="${idx}">Editar</button>
        <button class="btn small" data-remove="${idx}">Eliminar</button>
      </div>`;
    cont.appendChild(row);
    row.querySelector('[data-edit]').addEventListener('click', ()=> { const t = prompt('Editar saludo', s); if(t!=null){ cfg.revinculacion.saludos[idx] = t.trim(); markDirty(); renderRevinculacion(); renderPreview(); }});
    row.querySelector('[data-remove]').addEventListener('click', ()=> { if(confirm('Eliminar saludo?')){ cfg.revinculacion.saludos.splice(idx,1); markDirty(); renderRevinculacion(); renderPreview(); }});
  });
}

/* Add rev */
$('btnAddRev').addEventListener('click', ()=>{
  const txt = $('revAddText').value.trim(); if(!txt) return; const cfg = state.profiles[state.active];
  cfg.revinculacion.saludos.push(txt); $('revAddText').value=''; markDirty(); renderRevinculacion(); renderPreview(); showToast('Saludo agregado');
});

/* ========= Preview rendering ========= */
function renderPreview(){
  const cfg = state.profiles[state.active];
  const area = $('previewArea'); area.innerHTML = '';
  // Apply palette
  document.documentElement.style.setProperty('--accent', cfg.paleta.acento || '--accent');
  document.documentElement.style.setProperty('--accent-2', cfg.paleta.acento || '--accent-2');
  // show secciones in order
  (cfg.order || cfg.secciones.map(s=>s.id)).forEach(sid=>{
    const s = cfg.secciones.find(x=>x.id===sid) || cfg.secciones.find(x=>x.name===sid);
    if(!s) return;
    const box = document.createElement('div'); box.className='preview-group'; box.style.marginBottom='10px';
    box.innerHTML = `<h3 style="margin:0 0 6px">${escapeHtml(s.name)} <span class="small-muted">${s.buttons.length} botones</span></h3>`;
    s.buttons.forEach(btn=>{
      const el = document.createElement('div'); el.className='btn-preview'; el.style.marginBottom='6px';
      el.innerHTML = `<div style="display:flex;flex-direction:column"><span class="label">${escapeHtml(btn.name)}</span><span class="sub small-muted">${escapeHtml(btn.text).slice(0,60)}</span></div><span class="small-muted">copiar</span>`;
      el.style.cursor='pointer';
      el.addEventListener('click', ()=> { simulateCopy(btn.text, btn.name); });
      box.appendChild(el);
    });
    area.appendChild(box);
  });

  // Billeteras preview (visual demo like ChinBotones)
  if(cfg.billeteras.length){
    const box = document.createElement('div'); box.className='preview-group';
    box.innerHTML = `<h3 style="margin:0 0 6px">Billeteras <span class="small-muted">${cfg.billeteras.length}</span></h3>`;
    cfg.billeteras.forEach((w, idx)=>{
      const wrap = document.createElement('div'); wrap.className='preview-group';
      wrap.style.display='flex'; wrap.style.justifyContent='space-between'; wrap.style.alignItems='center'; wrap.style.padding='8px';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escapeHtml(w.label)}</div><div class="small-muted">${escapeHtml(w.alias || w.cbu)}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      const btnCBU = document.createElement('button'); btnCBU.className='btn ghost small'; btnCBU.textContent='CBU';
      const btnAlias = document.createElement('button'); btnAlias.className='btn small'; btnAlias.textContent='Alias';
      btnCBU.addEventListener('click', ()=> simulateCopy(w.cbu || '', (w.label||'') + ' CBU'));
      btnAlias.addEventListener('click', ()=> simulateCopy(`${w.alias}\nTitular ${w.titular} *${w.billetera || ''}*`, (w.label||'') + ' Alias'));
      right.appendChild(btnCBU); right.appendChild(btnAlias);
      wrap.appendChild(left); wrap.appendChild(right);
      box.appendChild(wrap);
    });
    area.appendChild(box);
  }
}

/* Simulated copy actions */
function simulateCopy(text, who){
  // create whatsapp link when it's from waMessage etc
  showToast(`Preview copiaría: ${who || 'texto'}`);
  $('lastToastText').textContent = (text||'').slice(0,120);
}

/* Fullscreen preview */
function toggleFullscreenPreview(){
  const fs = $('fullscreen');
  if(fs.classList.contains('show')){ fs.classList.remove('show'); fs.innerHTML=''; return; }
  const copy = $('previewArea').cloneNode(true);
  fs.appendChild(copy); fs.classList.add('show');
}

/* ========= Helpers ========= */
function escapeHtml(s){ if(!s) return ''; return (''+s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function escapeAttr(s){ return (''+s).replace(/"/g,'&quot;'); }
function markDirty(){ $('statusChip').textContent = 'Cambios (no exportado)'; saveAll(); }
function indicateSaved(){ $('statusChip').textContent = state.active ? ('Perfil: ' + state.active) : 'Sin perfil'; }

/* small helpers for old content */
function shorten(s, n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…':s; }

/* ========= Sections: initial seed if none ========= */
function ensureSections(){
  const cfg = state.profiles[state.active];
  if(!cfg.secciones || !Array.isArray(cfg.secciones) || cfg.secciones.length===0){
    cfg.secciones = [{ id:'utilidad', name:'Utilidad', buttons:[] }, { id:'billeteras', name:'Billeteras', buttons:[] }];
    cfg.order = ['utilidad','billeteras'];
  }
}

/* ========= Mark & initial transformations ========= */
function markDirtyNoSave(){ $('statusChip').textContent = 'Cambios'; }
function updateStatus(){ $('statusChip').textContent = state.active ? ('Perfil: ' + state.active) : 'Sin perfil'; }

/* Normalize shape on load */
(function postLoadInit(){
  Object.keys(state.profiles || {}).forEach(k=> { if(!state.profiles[k].secciones) state.profiles[k].secciones = [{id:'utilidad',name:'Utilidad',buttons:[]},{id:'billeteras',name:'Billeteras',buttons:[]}]; });
})();

/* Expose a small API for console debugging */
window.chinmaker = { state, saveAll, loadAll, renderPreview, renderAllEditor };

</script>
</body>
</html>
