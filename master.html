
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ChinMaker ‚Ä¢ Editor Unificado v4</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#050711;
      --bg-soft:#0b101d;
      --card:#101524;
      --card-soft:#141a2b;
      --accent:#8A2BE2;
      --accent-light:#a855f7;
      --ok:#10B981;
      --bad:#EF4444;
      --muted:#9ca3af;
      --text:#e5f3ff;
      --border:rgba(148,163,184,.25);
      --shadow:0 16px 40px rgba(0,0,0,.6);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,rgba(138,43,226,0.25),transparent 55%),
        radial-gradient(circle at bottom right,rgba(16,185,129,0.18),transparent 55%),
        linear-gradient(180deg,#030712,#020617 55%,#020617 100%);
      min-height:100vh;
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1320px;margin:0 auto;}

    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px;}
    .title-block h1{
      margin:0;font-size:22px;letter-spacing:.03em;
      background:linear-gradient(90deg,#f9fafb,var(--accent-light));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .title-block small{color:var(--muted);font-size:13px;}

    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
      background:rgba(15,23,42,.7);border:1px solid rgba(148,163,184,.4);font-size:11px;color:var(--muted);
    }

    .layout{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);gap:16px;}
    @media (max-width:980px){.layout{grid-template-columns:1fr;}}

    .card{
      background:radial-gradient(circle at top left,rgba(148,163,184,.16),transparent 55%),var(--card);
      border-radius:var(--radius);border:1px solid rgba(148,163,184,.25);box-shadow:var(--shadow);padding:14px 16px 16px;
    }
    .card h2{margin:0 0 8px;font-size:15px;letter-spacing:.04em;text-transform:uppercase;color:#e5e7eb;}
    .sub{margin-top:0;color:var(--muted);font-size:12px;}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    label{font-size:12px;color:var(--muted);margin-bottom:3px;display:block;}
    input[type=text], textarea, select, input[type=color]{
      width:100%;padding:7px 9px;border-radius:8px;border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.85);color:var(--text);font-size:13px;outline:none;
      transition:border-color .16s, box-shadow .16s, background .16s;
    }
    input[type=color]{padding:0.25rem;height:36px;cursor:pointer;background:#020617;}
    textarea{min-height:90px;resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color:var(--accent-light);box-shadow:0 0 0 1px rgba(168,85,247,.32);background:#020617;
    }
    select{
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%239ca3af' viewBox='0 0 20 20'%3E%3Cpath d='M5.25 7.5 10 12.25 14.75 7.5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 8px center;background-size:16px;padding-right:26px;
    }

    .btn{
      border:none;border-radius:999px;padding:7px 13px;font-size:12px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;
      display:inline-flex;align-items:center;gap:6px;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-light));
      color:white;box-shadow:0 10px 25px rgba(88,28,135,.5);transition:transform .12s, box-shadow .12s, opacity .12s;
    }
    .btn.small{padding:6px 10px;font-size:11px;}
    .btn.ghost{background:transparent;border-radius:10px;padding:7px 11px;border:1px solid rgba(148,163,184,.45);box-shadow:none;color:var(--muted);}
    .btn.warn{background:linear-gradient(90deg,#f97316,#facc15);box-shadow:0 10px 25px rgba(234,179,8,.45);}
    .btn.subtle{background:#111827;border-radius:9px;border:1px solid rgba(148,163,184,.5);box-shadow:none;}
    .btn.icon{width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;padding:0;border-radius:8px;background:#1f2530}

    .section-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:10px;}

    .list{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
    .card-row{
      background:var(--card-soft);border-radius:11px;border:1px solid rgba(148,163,184,.45);
      padding:9px 10px;display:grid;grid-template-columns:30px minmax(0,1fr);gap:8px;align-items:flex-start;position:relative;
    }
    .grip{
      width:28px;height:28px;border-radius:8px;background:#1f2530;color:#fff;cursor:grab;display:flex;align-items:center;justify-content:center;border:1px solid rgba(75,85,99,.8);
    }
    .card-row.dragging{opacity:.65;border-style:dashed;}
    .card-row.placeholder::after{
      content:'';position:absolute;left:0;right:0;height:4px;border-radius:999px;background:rgba(168,85,247,.35);
      transform:translateY(-6px);transition:.16s;
    }

    .wallet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
    .wallet-label{font-size:13px;font-weight:600;}
    .wallet-actions{display:flex;gap:6px;align-items:center;}

    .preview-card{background:radial-gradient(circle at top,rgba(248,250,252,.04),transparent 60%),var(--bg-soft);border-radius:var(--radius);border:1px solid rgba(148,163,184,.3);padding:12px 13px;box-shadow:var(--shadow);}
    .preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .preview-tabs{display:inline-flex;background:#020617;padding:2px;border-radius:999px;border:1px solid rgba(148,163,184,.35);}
    .tab-chip{padding:5px 10px;border-radius:999px;font-size:11px;cursor:pointer;color:var(--muted);}
    .tab-chip.active{background:linear-gradient(90deg,var(--accent),var(--accent-light));color:#f9fafb;}

    .preview-group{margin-bottom:10px;border-radius:10px;padding:9px 10px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.28);}
    .preview-group h3{margin:0 0 6px;font-size:13px;display:flex;align-items:center;justify-content:space-between;}
    .chip-mini{font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.55);color:var(--muted);}

    .wallets-face{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
    .wallet-btn{width:100%;padding:10px;border:none;border-radius:10px;background:#1b2029;color:#fff;font-weight:700;cursor:pointer;border:1px solid rgba(55,65,81,.9)}
    .wallet-btn:hover{background:#222836}

    .btn-preview{display:flex;justify-content:space-between;align-items:center;padding:7px 9px;border-radius:9px;background:linear-gradient(90deg,#111827,#020617);border:1px solid rgba(55,65,81,.9);cursor:pointer;font-size:12px;margin-bottom:5px;}
    .btn-preview span.label{font-weight:500;}
    .btn-preview span.sub{font-size:11px;color:var(--muted);}
    .btn-preview:hover{border-color:var(--accent-light);box-shadow:0 0 0 1px rgba(168,85,247,.35);}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(20px);padding:8px 11px;border-radius:999px;background:rgba(15,23,42,.96);border:1px solid rgba(148,163,184,.55);color:#e5e7eb;font-size:12px;display:flex;align-items:center;gap:8px;opacity:0;pointer-events:none;transition:opacity .16s, transform .16s;z-index:40;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
    .toast-icon{width:16px;height:16px;border-radius:999px;background:rgba(16,185,129,.12);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--ok);}

    .divider-label{margin:10px 0 6px;font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);}
    .muted{color:var(--muted);font-size:11px;}

    /* Flip animaci√≥n (preview visual) */
    .flip-card{position:relative;perspective:1000px;}
    .flip-inner{transition:transform .4s;transform-style:preserve-3d;}
    .flip-card.flipped .flip-inner{transform:rotateY(180deg);}
    .flip-face{backface-visibility:hidden;}
    .flip-back{transform:rotateY(180deg);}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title-block">
      <h1>ChinMaker ¬∑ Editor Unificado v4</h1>
      <small>Utilidad siempre arriba, billeteras al medio, promo + revin por PC abajo. Export√° a .chin.json.</small>
    </div>
    <div class="row">
      <div class="chip"><span>üíæ</span> <span id="chipStatus">Perfil guardado</span></div>
    </div>
  </header>

  <div class="card" style="margin-bottom:14px;">
    <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap">
      <div style="min-width:220px;">
        <label>Perfil activo</label>
        <div class="row" style="gap:6px;">
          <select id="profileSelect" style="flex:1;min-width:140px;"></select>
          <button class="btn small subtle" id="btnNewProfile">Nuevo</button>
        </div>
        <p class="muted" style="margin-top:3px;">Ej: PC01, PC02, Gonzales, CasinoCentro...</p>
      </div>
      <div class="row" style="gap:8px;">
        <input type="file" id="fileImport" accept=".json" style="display:none;">
        <button class="btn small" id="btnExport">Exportar perfil</button>
        <button class="btn small ghost" id="btnImport">Subir perfil</button>
        <button class="btn small warn" id="btnReset">Reiniciar perfil</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- EDITOR -->
    <div class="card">
      <h2>Editor de configuraci√≥n</h2>
      <p class="sub">Se guarda en el navegador y pod√©s exportarlo a <code>.chin.json</code>.</p>

      <div class="section-grid">
        <div><label>Color acento</label><input type="color" id="colorAccent" value="#8A2BE2"></div>
        <div><label>Color OK</label><input type="color" id="colorOk" value="#10B981"></div>
        <div><label>Color Error</label><input type="color" id="colorBad" value="#EF4444"></div>
      </div>

      <div class="divider-label">PCs y WhatsApp</div>
      <div class="row">
        <div style="flex:1;min-width:260px;">
          <label>PCs configuradas</label>
          <div class="row">
            <button class="btn small ghost" id="pcAddBtn">Agregar PC</button>
            <button class="btn small ghost" id="pcDelBtn">Eliminar √∫ltima PC</button>
            <span class="muted" id="pcCountNote">M√≠nimo 1, m√°ximo 10</span>
          </div>
          <div id="pcSlider" class="row" style="margin-top:6px;flex-wrap:wrap;"></div>
        </div>
        <div style="flex:1;min-width:260px;">
          <label>WhatsApp de la PC seleccionada</label>
          <input type="text" id="pcWsp" placeholder="5491100000000">
          <p class="muted">Al copiar WhatsApp, {usuario} se reemplaza por lo que escribas en la barra.</p>
        </div>
      </div>

      <div class="divider-label">Mensajes de revinculaci√≥n por PC</div>
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
        <p class="muted" style="margin:0;">Us√° {usuario}. Ej.: ‚ÄúHola {usuario}, somos BET300, renovamos nuestro n√∫mero a XXXXXXX‚Äù.</p>
        <button class="btn small subtle" id="btnAddSaludo">+ A√±adir mensaje</button>
      </div>
      <div class="list" id="saludosList"></div>

      <div class="divider-label">Mensaje al copiar WhatsApp</div>
      <div class="section-grid">
        <div>
          <label>Plantilla (usa {usuario})</label>
          <textarea id="waMensaje" placeholder="Hola soy {usuario} quiero mi clave y cronograma"></textarea>
        </div>
      </div>

      <div class="divider-label">Textos de utilidad</div>
      <div class="section-grid">
        <div>
          <label>Utilidad ¬∑ Info</label>
          <textarea id="utilInfo" data-default="info"></textarea>
        </div>
        <div>
          <label>Utilidad ¬∑ Cargado</label>
          <textarea id="utilCargado" data-default="cargado"></textarea>
        </div>
        <div>
          <label>Utilidad ¬∑ Retiro</label>
          <textarea id="utilRetiro" data-default="retiro"></textarea>
        </div>
      </div>

      <div class="divider-label">Billeteras</div>
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
        <p class="muted" style="margin:0;">Arrastr√° con el grip. Cada tarjeta es un grupo por nombre visible.</p>
        <button class="btn small subtle" id="btnAddWallet">+ A√±adir billetera</button>
      </div>
      <div class="list" id="walletList"></div>

      <div class="divider-label">Promo amigo</div>
      <div class="section-grid">
        <div>
          <label>Texto Promo Amigos</label>
          <textarea id="promoTexto"></textarea>
        </div>
        <div>
          <label>Info Promo Amigos</label>
          <textarea id="promoInfo"></textarea>
        </div>
        <div>
          <label>C√≥digos amigo (, R2...)</label>
          <input type="text" id="promoCodigos" placeholder=", R2, R3">
          <p class="muted">Se usa {codigo} seg√∫n la PC activa: PC01‚Üí, PC02‚ÜíR2, etc.</p>
        </div>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="preview-card">
      <div class="preview-header">
        <div>
          <div class="row" style="gap:6px;align-items:center;">
            <span class="muted" style="font-size:11px;">Vista previa</span>
          </div>
          <div class="muted" style="margin-top:2px;font-size:11px;">Los botones copian texto y muestran toasts.</div>
        </div>
        <div class="preview-tabs" id="previewTabs">
          <div class="tab-chip active" data-tab="utilidad">Utilidad</div>
          <div class="tab-chip" data-tab="billeteras">Billeteras</div>
          <div class="tab-chip" data-tab="promo">Promo amigo</div>
          <div class="tab-chip" data-tab="revin">Revin por PC</div>
        </div>
      </div>

      <div class="preview-group" id="userBarBox" style="display:none;">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div style="flex:1;min-width:240px;">
            <label>Usuario para {usuario}</label>
            <input type="text" id="previewUsuario" placeholder="Escrib√≠ el usuario...">
          </div>
          <div style="flex:1;min-width:240px;">
            <label>PC para vista previa</label>
            <div id="pcSliderPreview" class="row" style="flex-wrap:wrap;"></div>
          </div>
        </div>
      </div>

      <div id="previewContent"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-icon">‚úî</div>
  <span id="toastText">Copiado</span>
</div>

<script>
/* === Estado base === */
const STORAGE_LIST_KEY = 'chinmaker_profiles_list_v4';
const STORAGE_PREFIX = 'chinmaker_profile_v4_';
const STORAGE_LAST = 'chinmaker_last_profile_v4';

const DEFAULT_UTIL_INFO =
`‚ú® SOMOS BET300VIP ‚ú®

Disfrut√° de una PLATAF0RMA confiable con + de 2000 jueg0s 0nline üéÆ

üì≤ ¬øListo para disfrutar al m√°ximo? üöÄ

Para a√±adir saldo, lo haces mediante CBU. üßæ
‚ÄºÔ∏è RECORDAR SIEMPRE CONSULTARLO ANTES DE ENVIAR, YA QUE VAMOS CAMBIANDO LAS CUENTAS, DE LO CONTRARIO NO SE EFECTUAR√Å LA C4RGA. ‚ÄºÔ∏è
üì© Envianos el comprobante y empez√° a jugar. üöÄ

üìç C4RG4 M√çNIMA: $2000
üìç RET1R0 M√çNIMO: $5000
Sin Monto Maximo!!
Un retiro cada 24hs exactas!

üïê Atenci√≥n personalizada las 24hs los 365 dias del a√±o!!!!`;

const DEFAULT_UTIL_CARGADO =
`‚úÖ ¬°Saldo acreditado!
Tu cuenta ya est√° lista para girar y ganar üé∞
üçÄ ¬°√âxitos en cada tirada!
Si no ves doble tilde, Encontra nuestro numero de WhatsApp siempre actualizado en nuestro estado de perfil! 
üé∞ TAMBIEN PODES CARGARTE POR TU CUENTA!
 ACA EN https://bet300.site/
 tu mismo usuario, tu misma clave.
 12345a
 avisame si queres mas info`;

const DEFAULT_UTIL_RETIRO =
`‚úÖ Para hacer el retiro, mandanos estos datos
üîπCBU, No Alias(para evitar equivocaciones)
üîπMonto a retirar
üîπNombre Del Titular de la cuenta
Muchas Gracias! üëå`;

const DEFAULT_PROMO_TEXTO =
`üéâ PROMO AMIGOS üéâ

üí• Invit√° a tus amigos y gan√° fichas extra al instante.
üëâ Por cada amigo que cargue la m√≠nima, vos recib√≠s **$2.000 en fichas de regalo**.

üìå Ped√≠ tu C√ìDIGO AMIGO y compartilo.
M√°s amigos = m√°s fichas ü§ëüé∞

üîó https://bet300.site`;

const DEFAULT_PROMO_INFO =
`‚ÑπÔ∏è ¬øC√≥mo funciona la Promo Amigos?

1Ô∏è‚É£ Ped√≠ tu **C√ìDIGO AMIGO**.
2Ô∏è‚É£ Compartilo con tus conocidos.
3Ô∏è‚É£ Cuando tu invitado haga su **primera carga m√≠nima de $2.000**, debe enviar tu c√≥digo.
4Ô∏è‚É£ Una vez acreditada, vos recib√≠s **$2.000 en fichas para jugar**.

‚úÖ No hay l√≠mite de invitados: ¬°cuantos m√°s sumes, m√°s gan√°s!
‚ö†Ô∏è Solo v√°lido para usuarios nuevos que nunca hayan cargado antes.`;

const DEFAULT_CONFIG = () => ({
  perfil: 'PC01',
  fechaExport: null,
  paleta: { acento:'#8A2BE2', ok:'#10B981', bad:'#EF4444' },
  whatsapp: {
    plantillaMensaje: 'Hola soy {usuario} quiero mi clave y cronograma',
    pcs: [
      // L√≥gica solicitada: √≠ndice 0 es PC1 por defecto (una no unificada).
      { nombre:'PC01', wsp:'5491100000000', mensajes:[] }
    ]
  },
  billeteras: [],
  utilidad: { info: DEFAULT_UTIL_INFO, cargado: DEFAULT_UTIL_CARGADO, retiro: DEFAULT_UTIL_RETIRO },

  estructuraBotones: { orden: ['utilidad','billeteras','promoAmigo','revin'] }
});

let currentProfileName = 'PC01';
let config = DEFAULT_CONFIG();
let dirtyTimer = null;
let sliderIndex = 0; // PC seleccionada (editor)
let sliderPreviewIndex = 0; // PC seleccionada (preview)
let draggingWallet = null;

/* === LocalStorage === */
function loadProfileNames(){ try{ const raw = localStorage.getItem(STORAGE_LIST_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
function saveProfileNames(list){ localStorage.setItem(STORAGE_LIST_KEY, JSON.stringify(Array.from(new Set(list)))); }
function saveCurrentProfile(){
  const key = STORAGE_PREFIX + currentProfileName;
  localStorage.setItem(key, JSON.stringify(config));
  localStorage.setItem(STORAGE_LAST, currentProfileName);
  indicateSaved();
}
function loadProfile(name){
  const key = STORAGE_PREFIX + name;
  const raw = localStorage.getItem(key);
  if(!raw) return null;
  try{ return normalizeConfig(JSON.parse(raw)); }catch(e){ return null; }
}
function normalizeConfig(obj){
  const base = DEFAULT_CONFIG();
  const merged = {
    ...base,
    ...obj,
    paleta: { ...base.paleta, ...(obj.paleta||{}) },
    whatsapp: {
      ...base.whatsapp,
      ...(obj.whatsapp||{}),
      pcs: normalizePCs(obj.whatsapp?.pcs)
    },
    utilidad: { ...base.utilidad, ...(obj.utilidad||{}) },
    promoAmigo: { ...base.promoAmigo, ...(obj.promoAmigo||{}) },
    estructuraBotones: { ...base.estructuraBotones, ...(obj.estructuraBotones||{}) },
    billeteras: Array.isArray(obj.billeteras)? obj.billeteras : base.billeteras
  };
  if(!merged.utilidad.info) merged.utilidad.info = DEFAULT_UTIL_INFO;
  if(!merged.utilidad.cargado) merged.utilidad.cargado = DEFAULT_UTIL_CARGADO;
  if(!merged.utilidad.retiro) merged.utilidad.retiro = DEFAULT_UTIL_RETIRO;
  if(!merged.promoAmigo.texto) merged.promoAmigo.texto = DEFAULT_PROMO_TEXTO;
  if(!merged.promoAmigo.info) merged.promoAmigo.info = DEFAULT_PROMO_INFO;
  if(!Array.isArray(merged.promoAmigo.codigos) || !merged.promoAmigo.codigos.length){
    merged.promoAmigo.codigos = ['R1','R2','R3','R4','R5','R6','R7','R8','R9','R10'];
  }
  return merged;
}
function normalizePCs(list){
  let out = Array.isArray(list) ? list.filter(Boolean) : [];
  if(out.length===0){
    // m√≠nimo 1 (PC1) como pediste (no unificada)
    out = [{ nombre:'PC01', wsp:'5491100000000', mensajes:[] }];
  }
  // l√≠mite m√°ximo 10
  out = out.slice(0,10).map((pc,i)=>({
    nombre: pc.nombre || ('PC' + String(i+1).padStart(2,'0')),
    wsp: String(pc.wsp || '5491100000000'),
    mensajes: Array.isArray(pc.mensajes) ? pc.mensajes : []
  }));
  return out;
}

/* === Bootstrap === */
document.addEventListener('DOMContentLoaded', ()=>{
  bootstrapProfiles();
  bindEditorInputs();
  renderAll();
});

function bootstrapProfiles(){
  const list = loadProfileNames();
  const last = localStorage.getItem(STORAGE_LAST);
  if(last && list.includes(last)){
    currentProfileName = last;
    config = loadProfile(last) || DEFAULT_CONFIG();
  }else if(list.length){
    currentProfileName = list[0];
    config = loadProfile(list[0]) || DEFAULT_CONFIG();
  }else{
    currentProfileName = 'PC01';
    config = DEFAULT_CONFIG();
    saveProfileNames([currentProfileName]);
    saveCurrentProfile();
  }
  renderProfileSelect();
}

/* === Profile select === */
function renderProfileSelect(){
  const select = document.getElementById('profileSelect');
  const list = loadProfileNames();
  if(!list.includes(currentProfileName)) list.push(currentProfileName);
  select.innerHTML = '';
  list.forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    if(name === currentProfileName) opt.selected = true;
    select.appendChild(opt);
  });
}

/* === Bindings === */
function bindEditorInputs(){
  document.getElementById('profileSelect').addEventListener('change', e=>{
    const name = e.target.value || 'PC01';
    const existing = loadProfile(name);
    currentProfileName = name;
    config = existing || {...DEFAULT_CONFIG(), perfil:name};
    saveProfileNames([...loadProfileNames(), name]);
    sliderIndex = 0; sliderPreviewIndex = 0;
    renderAll();
  });

  document.getElementById('btnNewProfile').addEventListener('click', ()=>{
    const name = prompt('Nombre del nuevo perfil (ej. PC03, GONZALES):','PC03');
    if(!name) return;
    currentProfileName = name.trim();
    config = {...DEFAULT_CONFIG(), perfil:currentProfileName};
    saveProfileNames([...loadProfileNames(), currentProfileName]);
    renderProfileSelect();
    renderAll();
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if(!confirm('¬øReiniciar el perfil actual?')) return;
    config = {...DEFAULT_CONFIG(), perfil:currentProfileName};
    saveCurrentProfile();
    sliderIndex = 0; sliderPreviewIndex = 0;
    renderAll();
  });

  document.getElementById('btnExport').addEventListener('click', ()=>{
    config.fechaExport = new Date().toISOString();
    const blob = new Blob([JSON.stringify(config,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `${currentProfileName || 'perfil'}.chin.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast('Perfil exportado');
  });

  const importInput = document.getElementById('fileImport');
  document.getElementById('btnImport').addEventListener('click', ()=>importInput.click());
  importInput.addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      currentProfileName = obj.perfil || file.name.replace(/\.json$/i,'') || 'Importado';
      config = normalizeConfig(obj);
      saveProfileNames([...loadProfileNames(), currentProfileName]);
      renderProfileSelect(); saveCurrentProfile(); renderAll();
      showToast('Perfil importado correctamente');
    }catch(err){ alert('No se pudo importar el JSON.'); }
    finally{ importInput.value=''; }
  });

  /* Palette */
  const paletteMap = { colorAccent:['paleta','acento'], colorOk:['paleta','ok'], colorBad:['paleta','bad'] };
  Object.keys(paletteMap).forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', ()=>{
      const [a,b] = paletteMap[id]; config[a][b] = el.value; markDirty(); renderPreview();
    });
  });

  /* Mensaje WhatsApp plantilla */
  const waMensaje = document.getElementById('waMensaje');
  waMensaje.addEventListener('input', ()=>{
    config.whatsapp.plantillaMensaje = waMensaje.value; markDirty(); renderPreview();
  });

  /* PCs */
  document.getElementById('pcAddBtn').addEventListener('click', ()=>{
    const list = config.whatsapp.pcs;
    if(list.length >= 10){ showToast('M√°ximo 10 PCs'); return; }
    const idx = list.length+1; // PC2 si hab√≠a solo PC1
    const nombre = 'PC' + String(idx).padStart(2,'0');
    list.push({ nombre, wsp:'5491100000000', mensajes:[] });
    sliderIndex = list.length-1; sliderPreviewIndex = sliderIndex;
    markDirty(); renderPCSlider(); renderPCSliderPreview(); renderSaludosEditor(); renderPreview();
  });
  document.getElementById('pcDelBtn').addEventListener('click', ()=>{
    const list = config.whatsapp.pcs;
    if(list.length<=1){ showToast('M√≠nimo 1 PC'); return; }
    list.pop();
    sliderIndex = Math.max(0, Math.min(sliderIndex, list.length-1));
    sliderPreviewIndex = Math.max(0, Math.min(sliderPreviewIndex, list.length-1));
    markDirty(); renderPCSlider(); renderPCSliderPreview(); renderSaludosEditor(); renderPreview();
  });

  document.getElementById('pcWsp').addEventListener('input', (e)=>{
    const list = config.whatsapp.pcs; if(!list.length) return;
    list[sliderIndex].wsp = e.target.value.trim();
    markDirty(); renderPreview();
  });

  /* Mensajes de revinculaci√≥n por PC */
  document.getElementById('btnAddSaludo').addEventListener('click', ()=>{
    const pc = config.whatsapp.pcs[sliderIndex];
    pc.mensajes.push({ id:'m_'+Date.now(), texto:'Hola {usuario}, somos BET300, renovamos nuestro n√∫mero a XXXXXXX' });
    markDirty(); renderSaludosEditor(); renderPreview();
  });

  /* Utilidad placeholders estilo input (sin overlay) */
  ['utilInfo','utilCargado','utilRetiro'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('focus', ()=>{
      const def = getDefaultTextFor(el.dataset.default);
      if(el.value.trim() === def.trim()){ el.value = ''; }
    });
    el.addEventListener('blur', ()=>{
      if(!el.value.trim()){
        el.value = getDefaultTextFor(el.dataset.default);
      }
    });
    el.addEventListener('input', ()=>{
      const key = id==='utilInfo'?'info':(id==='utilCargado'?'cargado':'retiro');
      config.utilidad[key] = el.value;
      markDirty(); renderPreview();
    });
  });

  /* Promo amigo */
  document.getElementById('promoTexto').addEventListener('input', (e)=>{
    config.promoAmigo.texto = e.target.value; markDirty(); renderPreview();
  });
  document.getElementById('promoInfo').addEventListener('input', (e)=>{
    config.promoAmigo.info = e.target.value; markDirty(); renderPreview();
  });
  document.getElementById('promoCodigos').addEventListener('input', (e)=>{
    const arr = e.target.value.split(',').map(s=>s.trim()).filter(Boolean);
    config.promoAmigo.codigos = arr.length ? arr : ['R1','R2','R3','R4','R5','R6','R7','R8','R9','R10'];
    markDirty(); renderPreview();
  });

  /* Billeteras */
  document.getElementById('btnAddWallet').addEventListener('click', ()=>{
    config.billeteras.push({
      id:'w_'+Date.now(),
      label:'Grupo / Nombre visible',
      cbu:'', alias:'', titular:'',
      billetera:'Mercado Pago', billeteraCustom:'',
      color:'#1f6feb',
      flip:false,
      cbu2:'', alias2:'', titular2:'',
      billetera2:'Mercado Pago', billetera2Custom:'',
      color2:'#ff6f3d'
    });
    markDirty(); renderWallets(); renderPreview();
  });

  /* Preview tabs */
  document.getElementById('previewTabs').addEventListener('click', e=>{
    const tab = e.target.closest('.tab-chip'); if(!tab) return;
    document.querySelectorAll('.tab-chip').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('userBarBox').style.display = tab.dataset.tab === 'revin' ? '' : 'none';
    renderPreview();
  });

  /* Usuario preview */
  document.getElementById('previewUsuario').addEventListener('input', ()=> renderPreview());
}

/* === Dirty indicator === */
function markDirty(){
  const chip = document.getElementById('chipStatus');
  chip.textContent = 'Cambios sin guardar';
  if(dirtyTimer) clearTimeout(dirtyTimer);
  dirtyTimer = setTimeout(()=>{ saveCurrentProfile(); },400);
}
function indicateSaved(){ document.getElementById('chipStatus').textContent = 'Perfil guardado'; }

/* === Render general === */
function renderAll(){
  document.getElementById('colorAccent').value = config.paleta.acento || '#8A2BE2';
  document.getElementById('colorOk').value = config.paleta.ok || '#10B981';
  document.getElementById('colorBad').value = config.paleta.bad || '#EF4444';

  document.getElementById('waMensaje').value = config.whatsapp.plantillaMensaje || 'Hola soy {usuario} quiero mi clave y cronograma';

  // Utilidad defaults as placeholder-style
  document.getElementById('utilInfo').value = config.utilidad.info || DEFAULT_UTIL_INFO;
  document.getElementById('utilCargado').value = config.utilidad.cargado || DEFAULT_UTIL_CARGADO;
  document.getElementById('utilRetiro').value = config.utilidad.retiro || DEFAULT_UTIL_RETIRO;

  // Promo defaults
  document.getElementById('promoTexto').value = config.promoAmigo.texto || DEFAULT_PROMO_TEXTO;
  document.getElementById('promoInfo').value = config.promoAmigo.info || DEFAULT_PROMO_INFO;
  document.getElementById('promoCodigos').value = (config.promoAmigo.codigos||[]).join(', ');

  renderPCSlider();
  renderPCSliderPreview();
  renderSaludosEditor();
  renderWallets();
  const activeTab = document.querySelector('.tab-chip.active')?.dataset.tab || 'utilidad';
  document.getElementById('userBarBox').style.display = activeTab === 'revin' ? '' : 'none';
  renderPreview();
}

/* === PCs sliders (editor y preview) === */
function renderPCSlider(){
  const cont = document.getElementById('pcSlider'); cont.innerHTML = '';
  const list = config.whatsapp.pcs;
  document.getElementById('pcCountNote').textContent = `M√≠nimo 1, m√°ximo 10 (${list.length})`;
  list.forEach((pc, i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn small ghost';
    btn.textContent = pc.nombre;
    btn.style.borderColor = i===sliderIndex ? 'var(--accent-light)' : 'rgba(148,163,184,.45)';
    btn.style.color = i===sliderIndex ? '#e5e7eb' : 'var(--muted)';
    btn.addEventListener('click', ()=>{
      sliderIndex = i;
      document.getElementById('pcWsp').value = pc.wsp || '';
      renderPCSlider(); renderSaludosEditor(); renderPreview();
    });
    cont.appendChild(btn);
  });
  document.getElementById('pcWsp').value = (list[sliderIndex]?.wsp || '');
}

function renderPCSliderPreview(){
  const cont = document.getElementById('pcSliderPreview'); cont.innerHTML = '';
  const list = config.whatsapp.pcs;
  list.forEach((pc, i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn small ghost';
    btn.textContent = pc.nombre;
    btn.style.borderColor = i===sliderPreviewIndex ? 'var(--accent-light)' : 'rgba(148,163,184,.45)';
    btn.style.color = i===sliderPreviewIndex ? '#e5e7eb' : 'var(--muted)';
    btn.addEventListener('click', ()=>{
      sliderPreviewIndex = i;
      renderPCSliderPreview(); renderPreview();
    });
    cont.appendChild(btn);
  });
}

/* === Mensajes de revinculaci√≥n por PC (editor) === */
function renderSaludosEditor(){
  const listEl = document.getElementById('saludosList'); listEl.innerHTML = '';
  const pc = config.whatsapp.pcs[sliderIndex];
  const arr = pc.mensajes || [];
  if(!arr.length){
    const p = document.createElement('p'); p.className='muted';
    p.textContent = 'No hay mensajes cargados para esta PC.';
    listEl.appendChild(p);
  }
  arr.forEach((s,idx)=>{
    const row = document.createElement('div');
    row.className = 'card-row';
    row.innerHTML = `
      <button class="btn icon" title="Arrastrar (deshabilitado)">‚ò∞</button>
      <div>
        <div class="wallet-header">
          <span class="wallet-label">Mensaje #${idx+1}</span>
          <div class="wallet-actions">
            <button class="btn small subtle" data-remove-s="${idx}" title="Eliminar">‚úï</button>
          </div>
        </div>
        <div>
          <label>Us√° {usuario} en el texto</label>
          <textarea data-s-idx="${idx}" placeholder="Hola {usuario}, somos BET300, renovamos nuestro n√∫mero a XXXXXXX">${escapeHtml(s.texto||'')}</textarea>
        </div>
      </div>
    `;
    listEl.appendChild(row);
  });

  listEl.querySelectorAll('textarea[data-s-idx]').forEach(el=>{
    el.addEventListener('input', ()=>{
      const i = parseInt(el.dataset.sIdx,10);
      pc.mensajes[i].texto = el.value;
      markDirty(); renderPreview();
    });
  });
  listEl.querySelectorAll('[data-remove-s]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = parseInt(btn.dataset.removeS,10);
      pc.mensajes.splice(i,1);
      markDirty(); renderSaludosEditor(); renderPreview();
    });
  });
}

/* === Billeteras editor (drag solo con grip & flip bot√≥n) === */
const WALLET_OPTS = ['Mercado Pago','Ual√°','Brubank','Banco Naci√≥n','Santander','Galicia','BBVA','PPay','Ripio','Prex','Otro'];

function renderWallets(){
  const listEl = document.getElementById('walletList'); listEl.innerHTML = '';
  (config.billeteras||[]).forEach((w,idx)=>{
    const row = document.createElement('div');
    row.className = 'card-row';
    row.dataset.index = idx;
    row.innerHTML = `
      <button class="grip" data-grip title="Arrastrar">‚ò∞</button>
      <div>
        <div class="wallet-header">
          <span class="wallet-label">${escapeHtml(w.label || 'Grupo / Nombre visible')}</span>
          <div class="wallet-actions">
            <button class="btn small ghost" data-toggle-flip="${idx}" title="Flip">‚Üª Flip</button>
            <span class="muted">A√±ade otra billetera del mismo titular</span>
            <button class="btn small subtle" data-remove="${idx}" title="Eliminar grupo">‚úï</button>
          </div>
        </div>
        <div class="section-grid">
          <div><label>Nombre visible</label><input type="text" data-field="label" data-idx="${idx}" value="${escapeAttr(w.label||'')}" /></div>

          <div>
            <label>CBU</label>
            <input type="text" inputmode="numeric" pattern="\\d*" maxlength="22" data-field="cbu" data-idx="${idx}" value="${escapeAttr(w.cbu||'')}" />
            <small class="muted">Solo n√∫meros, 22 d√≠gitos</small>
          </div>

          <div><label>Alias</label><input type="text" data-field="alias" data-idx="${idx}" value="${escapeAttr(w.alias||'')}" /></div>
          <div><label>Titular</label><input type="text" data-field="titular" data-idx="${idx}" value="${escapeAttr(w.titular||'')}" /></div>
          <div>
            <label>Billetera</label>
            <select data-field="billetera" data-idx="${idx}">
              ${WALLET_OPTS.map(opt=>`<option value="${opt}" ${w.billetera===opt?'selected':''}>${opt}</option>`).join('')}
            </select>
            <input type="text" data-field="billeteraCustom" data-idx="${idx}" placeholder="Nombre billetera" style="margin-top:4px;${w.billetera==='Otro'?'':'display:none'}" value="${escapeAttr(w.billeteraCustom||'')}" />
          </div>
          <div><label>Color</label><input type="color" data-field="color" data-idx="${idx}" value="${escapeAttr(w.color||'#1f6feb')}"></div>
        </div>

        ${w.flip ? `
        <div class="section-grid flip-section">
          <div>
            <label>CBU (segunda)</label>
            <input type="text" inputmode="numeric" pattern="\\d*" maxlength="22" data-field="cbu2" data-idx="${idx}" value="${escapeAttr(w.cbu2||'')}" />
            <small class="muted">Solo n√∫meros, 22 d√≠gitos</small>
          </div>
          <div><label>Alias (segunda)</label><input type="text" data-field="alias2" data-idx="${idx}" value="${escapeAttr(w.alias2||'')}" /></div>
          <div><label>Titular (segunda)</label><input type="text" data-field="titular2" data-idx="${idx}" value="${escapeAttr(w.titular2||'')}" /></div>
          <div>
            <label>Billetera (segunda)</label>
            <select data-field="billetera2" data-idx="${idx}">
              ${WALLET_OPTS.map(opt=>`<option value="${opt}" ${w.billetera2===opt?'selected':''}>${opt}</option>`).join('')}
            </select>
            <input type="text" data-field="billetera2Custom" data-idx="${idx}" placeholder="Nombre billetera" style="margin-top:4px;${w.billetera2==='Otro'?'':'display:none'}" value="${escapeAttr(w.billetera2Custom||'')}" />
          </div>
          <div><label>Color (segunda)</label><input type="color" data-field="color2" data-idx="${idx}" value="${escapeAttr(w.color2||'#ff6f3d')}"></div>
        </div>`:''}
      </div>
    `;
    listEl.appendChild(row);
  });

  // edici√≥n
  listEl.querySelectorAll('input[data-field], select[data-field]').forEach(el=>{
    el.addEventListener('input', onWalletFieldChange);
    el.addEventListener('change', onWalletFieldChange);
  });
  // numeric enforcement for CBU/CBU2
  listEl.querySelectorAll('input[data-field="cbu"], input[data-field="cbu2"]').forEach(el=>{
    el.addEventListener('input', ()=>{
      el.value = el.value.replace(/\D/g,'').slice(0,22);
      const idx = parseInt(el.dataset.idx,10);
      const field = el.dataset.field;
      const w = config.billeteras[idx]; if(!w) return;
      w[field] = el.value;
      markDirty(); renderPreview();
    });
  });

  listEl.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.dataset.remove,10);
      if(isNaN(idx)) return;
      if(!confirm('¬øEliminar este grupo?')) return;
      config.billeteras.splice(idx,1);
      markDirty(); renderWallets(); renderPreview();
    });
  });

  listEl.querySelectorAll('[data-toggle-flip]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.dataset.toggleFlip,10);
      const w = config.billeteras[idx];
      w.flip = !w.flip;
      // copiar datos de titular y billetera si se activa
      if(w.flip){
        w.titular2 = w.titular || '';
        w.billetera2 = w.billetera || 'Mercado Pago';
        w.color2 = w.color || '#ff6f3d';
      }
      markDirty(); renderWallets(); renderPreview();
    });
  });

  // drag solo con grip
  listEl.querySelectorAll('[data-grip]').forEach(grip=>{
    const row = grip.closest('.card-row');
    grip.addEventListener('mousedown', e=>{
      draggingWallet = row;
      row.classList.add('dragging');
      e.preventDefault();
    });
  });
  document.addEventListener('mousemove', e=>{
    if(!draggingWallet) return;
    const listEl = document.getElementById('walletList');
    const rows = Array.from(listEl.children);
    const y = e.clientY;
    let target = null;
    rows.forEach(r=>{
      const rect = r.getBoundingClientRect();
      r.classList.remove('placeholder');
      if(y>rect.top && y<rect.bottom) target = r;
    });
    if(target && target!==draggingWallet){
      target.classList.add('placeholder');
    }
  });
  document.addEventListener('mouseup', e=>{
    if(!draggingWallet) return;
    const listEl = document.getElementById('walletList');
    const rows = Array.from(listEl.children);
    let toIdx = null;
    rows.forEach((r,i)=>{
      if(r.classList.contains('placeholder')){ toIdx = i; r.classList.remove('placeholder'); }
    });
    const fromIdx = parseInt(draggingWallet.dataset.index,10);
    draggingWallet.classList.remove('dragging');
    draggingWallet = null;
    if(toIdx===null || isNaN(fromIdx)) return;
    const arr = config.billeteras;
    const item = arr.splice(fromIdx,1)[0];
    arr.splice(toIdx,0,item);
    markDirty(); renderWallets(); renderPreview();
  });
}

function onWalletFieldChange(e){
  const idx = parseInt(e.target.dataset.idx,10);
  const field = e.target.dataset.field;
  const w = config.billeteras[idx]; if(!w) return;
  if(field==='billetera' || field==='billetera2'){
    w[field] = e.target.value;
    const customField = field==='billetera'?'billeteraCustom':'billetera2Custom';
    const inputCustom = e.target.parentElement.querySelector(`input[data-field="${customField}"]`);
    if(inputCustom){ inputCustom.style.display = e.target.value==='Otro' ? '' : 'none'; }
  }else{ w[field] = e.target.value; }
  markDirty(); renderPreview();
}

/* === Preview === */
function getActiveTab(){
  const active = document.querySelector('.tab-chip.active');
  return active ? active.dataset.tab : 'utilidad';
}
function applyPalette(){
  const p = config.paleta || {};
  document.documentElement.style.setProperty('--accent', p.acento || '#8A2BE2');
  document.documentElement.style.setProperty('--accent-light', p.acento || '#a855f7');
  document.documentElement.style.setProperty('--ok', p.ok || '#10B981');
  document.documentElement.style.setProperty('--bad', p.bad || '#EF4444');
}

function renderPreview(){
  applyPalette();
  const content = document.getElementById('previewContent'); content.innerHTML = '';
  const tab = getActiveTab();
  const usuario = (document.getElementById('previewUsuario').value || 'USUARIO').trim();
  const pcs = config.whatsapp.pcs;
  const pc = pcs[sliderPreviewIndex] || pcs[0];

  if(tab === 'utilidad'){
    const g = document.createElement('div'); g.className='preview-group';
    g.innerHTML = `<h3>Utilidad <span class="chip-mini">Texto fijo</span></h3>`;
    const blocks = [
      { key:'info', label:'Info', val: config.utilidad.info || DEFAULT_UTIL_INFO },
      { key:'cargado', label:'Cargado', val: config.utilidad.cargado || DEFAULT_UTIL_CARGADO },
      { key:'retiro', label:'Retiro', val: config.utilidad.retiro || DEFAULT_UTIL_RETIRO }
    ];
    blocks.forEach(b=>{
      const btn = document.createElement('div'); btn.className='btn-preview';
      btn.innerHTML = `<div><span class="label">${b.label}</span><div class="sub">${escapeHtml(shorten(b.val,160))}</div></div><span class="sub">copiar</span>`;
      btn.addEventListener('click', ()=>{ copyToClipboard(b.val); showToast(`Copiado texto de ${b.label}`); });
      g.appendChild(btn);
    });
    content.appendChild(g);
  }

  if(tab === 'billeteras'){
    const g = document.createElement('div'); g.className='preview-group';
    g.innerHTML = `<h3>Billeteras por grupo <span class="chip-mini">${config.billeteras.length} grupos</span></h3>`;
    if(!(config.billeteras||[]).length){
      const p = document.createElement('p'); p.className='muted'; p.textContent='Sin billeteras cargadas.'; g.appendChild(p);
    }else{
      const byLabel = {};
      config.billeteras.forEach(w=>{ const k = (w.label||'Grupo'); (byLabel[k]||(byLabel[k]=[])).push(w); });
      Object.keys(byLabel).forEach(label=>{
        const subgroup = document.createElement('div'); subgroup.className='preview-group';
        subgroup.innerHTML = `<h3>${escapeHtml(label)} <span class="chip-mini">${byLabel[label].length} billetera(s)</span></h3>`;
        const grid = document.createElement('div'); grid.className='wallets-face';
        byLabel[label].forEach(w=>{
          // frente/dorso como botones
          const frontCBU = document.createElement('button');
          frontCBU.className='wallet-btn'; frontCBU.textContent = `CBU ${billeName(w)}`;
          frontCBU.style.borderColor = w.color || '#1f6feb';
          frontCBU.addEventListener('click', ()=>{
            const val = (w.cbu||'').trim();
            if(!val) return showToast('CBU vac√≠o');
            copyToClipboard(val);
            showToast(`Copiado CBU de ${w.titular||'Titular'}`);
          });
          grid.appendChild(frontCBU);

          const frontAlias = document.createElement('button');
          frontAlias.className='wallet-btn'; frontAlias.textContent = `Alias ${billeName(w)}`;
          frontAlias.style.borderColor = w.color || '#1f6feb';
          frontAlias.addEventListener('click', ()=>{
            const msg = `${w.alias||''}\nTitular ${w.titular||''} *${billeName(w)}*`;
            copyToClipboard(msg.trim());
            showToast(`Copiado Alias de ${w.titular||'Titular'}`);
          });
          grid.appendChild(frontAlias);

          if(w.flip){
            const backCBU = document.createElement('button');
            backCBU.className='wallet-btn'; backCBU.textContent = `CBU ${billeName2(w)}`;
            backCBU.style.borderColor = w.color2 || '#ff6f3d';
            backCBU.addEventListener('click', ()=>{
              const val = (w.cbu2||'').trim();
              if(!val) return showToast('CBU (segunda) vac√≠o');
              copyToClipboard(val);
              showToast(`Copiado CBU (segunda) de ${w.titular2||'Titular'}`);
            });
            grid.appendChild(backCBU);

            const backAlias = document.createElement('button');
            backAlias.className='wallet-btn'; backAlias.textContent = `Alias ${billeName2(w)}`;
            backAlias.style.borderColor = w.color2 || '#ff6f3d';
            backAlias.addEventListener('click', ()=>{
              const msg = `${w.alias2||''}\nTitular ${w.titular2||''} *${billeName2(w)}*`;
              copyToClipboard(msg.trim());
              showToast(`Copiado Alias (segunda) de ${w.titular2||'Titular'}`);
            });
            grid.appendChild(backAlias);
          }
        });
        subgroup.appendChild(grid);
        g.appendChild(subgroup);
      });
    }
    content.appendChild(g);
  }

  if(tab === 'promo'){
    const g = document.createElement('div'); g.className='preview-group';
    g.innerHTML = `<h3>Promo amigo <span class="chip-mini">2 botones</span></h3>`;
    // Bot√≥n Promo
    const btnPromo = document.createElement('div'); btnPromo.className='btn-preview';
    btnPromo.innerHTML = `<div><span class="label">üéâ Promo Amigos</span><div class="sub">${escapeHtml(shorten(config.promoAmigo.texto||DEFAULT_PROMO_TEXTO,160))}</div></div><span class="sub">copiar</span>`;
    btnPromo.addEventListener('click', ()=>{ copyToClipboard(config.promoAmigo.texto||DEFAULT_PROMO_TEXTO); showToast('Copiado Promo Amigos'); });
    g.appendChild(btnPromo);
    // Bot√≥n Info
    const btnInfo = document.createElement('div'); btnInfo.className='btn-preview';
    btnInfo.innerHTML = `<div><span class="label">‚ÑπÔ∏è Info Promo</span><div class="sub">${escapeHtml(shorten(config.promoAmigo.info||DEFAULT_PROMO_INFO,160))}</div></div><span class="sub">copiar</span>`;
    btnInfo.addEventListener('click', ()=>{ copyToClipboard(config.promoAmigo.info||DEFAULT_PROMO_INFO); showToast('Copiado Info Promo'); });
    g.appendChild(btnInfo);
    content.appendChild(g);
  }

  if(tab === 'revin'){
    const g = document.createElement('div'); g.className='preview-group';
    const mensajes = pc.mensajes||[];
    g.innerHTML = `<h3>PC ${escapeHtml(pc.nombre)} ¬∑ Mensajes y WhatsApp <span class="chip-mini">${mensajes.length} mensajes</span></h3>`;

    // WhatsApp √∫nico para esta PC (usa plantilla editable)
    const plantilla = (config.whatsapp.plantillaMensaje || 'Hola soy {usuario} quiero mi clave y cronograma').replace(/\{usuario\}/g, usuario);
    const wspNum = (pc.wsp||'5491100000000').trim();
    const wspLink = `https://wa.me/${encodeURIComponent(wspNum)}?text=${encodeURIComponent(plantilla)}`;
    const btnWsp = document.createElement('div'); btnWsp.className='btn-preview';
    btnWsp.innerHTML = `<div><span class="label">Copiar WhatsApp (${escapeHtml(pc.nombre)})</span><div class="sub">${escapeHtml(shorten(wspLink,100))}</div></div><span class="sub">copiar</span>`;
    btnWsp.addEventListener('click', ()=>{ copyToClipboard(wspLink); showToast(`Copiado WhatsApp (${pc.nombre})`); });
    g.appendChild(btnWsp);

    // C√≥digo amigo seg√∫n PC activa
    const codeIdx = Math.min(sliderPreviewIndex, (config.promoAmigo.codigos||[]).length-1);
    const codeVal = (config.promoAmigo.codigos||[])[codeIdx] || 'R1';
    const codeMsg = (config.promoAmigo.texto||DEFAULT_PROMO_TEXTO).replace(/\{codigo\}/g, codeVal).replace(/\{usuario\}/g, usuario);
    const btnCodigo = document.createElement('div'); btnCodigo.className='btn-preview';
    btnCodigo.innerHTML = `<div><span class="label">C√≥digo amigo (${escapeHtml(codeVal)})</span><div class="sub">${escapeHtml(shorten(codeMsg,100))}</div></div><span class="sub">copiar</span>`;
    btnCodigo.addEventListener('click', ()=>{ copyToClipboard(codeMsg); showToast(`Copiado C√≥digo Amigo (${codeVal})`); });
    g.appendChild(btnCodigo);

    if(!mensajes.length){
      const p = document.createElement('p'); p.className='muted'; p.textContent='Sin mensajes de revinculaci√≥n para esta PC.'; g.appendChild(p);
    }else{
      mensajes.forEach((m,i)=>{
        const txt = (m.texto||'').replace(/\{usuario\}/g, usuario);
        const btn = document.createElement('div'); btn.className='btn-preview';
        btn.innerHTML = `<div><span class="label">Mensaje #${i+1}</span><div class="sub">${escapeHtml(shorten(txt,160))}</div></div><span class="sub">copiar</span>`;
        btn.addEventListener('click', ()=>{ copyToClipboard(txt); showToast(`Copiado mensaje #${i+1}`); });
        g.appendChild(btn);
      });
    }
    content.appendChild(g);
  }
}

/* === Helpers === */
function billeName(w){ return w.billetera==='Otro' ? (w.billeteraCustom||'Billetera') : (w.billetera||'Billetera'); }
function billeName2(w){ return w.billetera2==='Otro' ? (w.billetera2Custom||'Billetera') : (w.billetera2||'Billetera'); }
function getDefaultTextFor(kind){
  if(kind==='info') return DEFAULT_UTIL_INFO;
  if(kind==='cargado') return DEFAULT_UTIL_CARGADO;
  if(kind==='retiro') return DEFAULT_UTIL_RETIRO;
  return '';
}

function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }
function shorten(str,max){ if(!str) return ''; str=String(str); return str.length>max ? str.slice(0,max-3)+'...' : str; }
async function copyToClipboard(text){ try{ await navigator.clipboard.writeText(String(text)); }catch(e){} }
let toastTimer = null;
function showToast(msg){
  const toast = document.getElementById('toast');
  document.getElementById('toastText').textContent = msg;
  toast.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toast.classList.remove('show'),1800);
}

/* === Init end === */
</script>
</body>
</html>
