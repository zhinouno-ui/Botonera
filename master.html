<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ChinMaker ‚Ä¢ Editor Unificado v5 (fix)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ...single unified CSS (suavizado inputs + layout + flip) --- kept concise --- */
    :root{
      --bg:#050711; --bg-soft:#0b101d; --card:#101524; --card-soft:#141a2b;
      --accent:#8A2BE2; --accent-light:#a855f7; --ok:#10B981; --bad:#EF4444;
      --muted:#9ca3af; --text:#e5f3ff;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(180deg,#030712,#020617);color:var(--text);padding:18px;}
    .wrap{max-width:1200px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
    h1{margin:0;font-size:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,.5);}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px;}
    input[type=text], textarea, select, input[type=color]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      color:var(--text);font-size:13px;outline:none;box-shadow: inset 0 2px 6px rgba(0,0,0,.45);
      transition: border-color .18s, box-shadow .18s, transform .12s;
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent-light);box-shadow:0 8px 30px rgba(168,85,247,.08);transform:translateY(-1px);}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:16px;}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .list{display:flex;flex-direction:column;gap:10px}
    .card-row{display:grid;grid-template-columns:36px 1fr;gap:10px;padding:10px;border-radius:10px;background:rgba(0,0,0,0.12)}
    .grip{width:36px;height:36px;border-radius:8px;background:#111827;display:flex;align-items:center;justify-content:center;cursor:grab}
    .wallet-header{display:flex;justify-content:space-between;align-items:center}
    .btn{padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-light));border:none;color:#fff;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn.subtle{background:#111827}
    .preview-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04))}
    .flip-card{position:relative; width:100%; border-radius:10px; overflow:hidden; background:#0f1724; height:140px; perspective:900px;}
    .flip-inner{position:relative;width:100%;height:100%;transition:transform .5s;transform-style:preserve-3d}
    .flip-card.flipped .flip-inner{transform:rotateY(180deg)}
    .flip-face{position:absolute;inset:0;padding:12px;backface-visibility:hidden;display:flex;flex-direction:column;gap:8px}
    .flip-back{transform:rotateY(180deg)}
    .wallet-btn{width:100%;padding:10px;border-radius:8px;border:none;background:#1b2029;color:#fff;cursor:pointer}
    .chip-mini{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,0.25);color:var(--muted);display:inline-block}
    .muted{color:var(--muted);font-size:13px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;border-radius:999px;background:#0b1220;color:#fff;opacity:0;pointer-events:none;transition:opacity .18s}
    .toast.show{opacity:1;pointer-events:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ChinMaker ¬∑ Editor Unificado v5</h1>
        <div class="muted">Flip animado ¬∑ Editor & Preview</div>
      </div>
      <div class="muted" id="chipStatus">Perfil guardado</div>
    </header>

    <div class="layout">
      <div class="card" id="editorCard">
        <!-- editor left (inputs, pcs, mensajes, wallets form) -->
        <h3>Editor</h3>
        <div style="margin-bottom:10px">
          <label>Plantilla WhatsApp</label>
          <textarea id="waMensaje" placeholder="Hola {usuario}..."></textarea>
        </div>

        <div style="margin-bottom:10px">
          <label>Promo prefix</label>
          <input id="promoPrefix" type="text" maxlength="4" placeholder="R">
        </div>

        <div class="divider" style="margin:10px 0;border-top:1px dashed rgba(255,255,255,0.03)"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="muted">Billeteras</div>
          <div>
            <button class="btn small" id="btnAddWallet">+ A√±adir</button>
          </div>
        </div>

        <div class="list" id="walletList"></div>
      </div>

      <div class="preview-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="muted">Vista previa</div>
          <div>
            <button class="btn small" id="saveBtn">Guardar</button>
          </div>
        </div>
        <div id="previewContent"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copiado</div>

  <script>
  // ...existing code (utils + state initialization)...

  // filepath: c:\Users\PC\Untitled-1.html (JS section)
  (function(){
    // state
    const STORAGE_PREFIX = 'chinmaker_profile_v5_';
    let config = { billeteras: [], whatsapp:{plantillaMensaje:'Hola {usuario}'}, promoAmigo:{prefix:'R'} };
    // helpers
    function showToast(txt){ const t=document.getElementById('toast'); t.textContent=txt; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // color helpers: dark HSL non-repeating
    function randDarkHsl(){ const h=Math.floor(Math.random()*360); const s=40+Math.floor(Math.random()*30); const l=18+Math.floor(Math.random()*12); return `hsl(${h} ${s}% ${l}%)`; }
    function ensureWalletColors(){
      const used = new Set();
      (config.billeteras||[]).forEach(w=>{ if(w.color) used.add(w.color); if(w.color2) used.add(w.color2); });
      (config.billeteras||[]).forEach(w=>{
        if(!w.color){ let c; do{ c=randDarkHsl(); } while(used.has(c)); used.add(c); w.color=c; }
        if(!w.color2){ let c; do{ c=randDarkHsl(); } while(used.has(c)); used.add(c); w.color2=c; }
      });
    }

    // render wallets editor
    function renderWallets(){
      ensureWalletColors();
      const listEl = document.getElementById('walletList'); listEl.innerHTML='';
      (config.billeteras||[]).forEach((w,idx)=>{
        const row = document.createElement('div'); row.className='card-row';
        row.innerHTML = `
          <div class="grip">‚â°</div>
          <div>
            <div class="wallet-header">
              <strong>${escapeHtml(w.label||'Grupo')}</strong>
              <div>
                <button class="btn small" data-toggle="${idx}">üîÅ</button>
                <button class="btn small subtle" data-remove="${idx}">Eliminar</button>
              </div>
            </div>
            <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label>Nombre visible</label>
                <input data-idx="${idx}" data-field="label" value="${escapeHtml(w.label||'')}">
              </div>
              <div>
                <label>CBU</label>
                <input data-idx="${idx}" data-field="cbu" value="${escapeHtml(w.cbu||'')}">
              </div>
              <div>
                <label>Alias</label>
                <input data-idx="${idx}" data-field="alias" value="${escapeHtml(w.alias||'')}">
              </div>
              <div>
                <label>Titular</label>
                <input data-idx="${idx}" data-field="titular" value="${escapeHtml(w.titular||'')}">
              </div>
            </div>
            <div style="margin-top:8px">
              <label><input type="checkbox" data-idx="${idx}" data-field="flip" ${w.flip ? 'checked' : ''}> Activar dorso</label>
            </div>
          </div>
        `;
        listEl.appendChild(row);
      });

      // bindings
      listEl.querySelectorAll('[data-field]').forEach(el=>{
        el.oninput = (e)=>{
          const idx = +el.dataset.idx; const field = el.dataset.field;
          const w = config.billeteras[idx]; if(!w) return;
          if(el.type==='checkbox'){ w[field]=el.checked; } else { w[field]=el.value; }
          renderPreview();
          saveLocal();
        };
      });
      listEl.querySelectorAll('[data-toggle]').forEach(btn=>{
        btn.onclick = ()=>{ const idx=+btn.dataset.toggle; config.billeteras[idx].flip = !config.billeteras[idx].flip; renderWallets(); renderPreview(); saveLocal(); };
      });
      listEl.querySelectorAll('[data-remove]').forEach(btn=>{
        btn.onclick = ()=>{ const idx=+btn.dataset.remove; config.billeteras.splice(idx,1); renderWallets(); renderPreview(); saveLocal(); };
      });
    }

    // render preview simplified (flip cards)
    function renderPreview(){
      ensureWalletColors();
      const content = document.getElementById('previewContent'); content.innerHTML='';
      const container = document.createElement('div'); container.className='preview-group';
      container.innerHTML = `<h3>Billeteras <span class="chip-mini">${(config.billeteras||[]).length} grupos</span></h3>`;
      const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gap='10px';
      (config.billeteras||[]).forEach(w=>{
        const card = document.createElement('div'); card.className='flip-card';
        if(w.flippedPreview) card.classList.add('flipped');
        const inner = document.createElement('div'); inner.className='flip-inner';
        const front = document.createElement('div'); front.className='flip-face';
        const f1 = document.createElement('button'); f1.className='wallet-btn'; f1.style.borderColor = w.color; f1.textContent = 'CBU ' + (w.alias||'');
        f1.onclick = ()=>{ if(w.cbu) { navigator.clipboard.writeText(w.cbu); showToast('CBU copiado'); } else showToast('CBU vac√≠o'); };
        const f2 = document.createElement('button'); f2.className='wallet-btn'; f2.style.borderColor = w.color; f2.textContent = 'Alias ' + (w.alias||'');
        f2.onclick = ()=>{ const txt = `${w.alias||''}\nTitular ${w.titular||''}`; navigator.clipboard.writeText(txt); showToast('Alias copiado'); };
        front.appendChild(f1); front.appendChild(f2);

        const back = document.createElement('div'); back.className='flip-face flip-back';
        if(w.flip){
          const b1=document.createElement('button'); b1.className='wallet-btn'; b1.style.borderColor=w.color2; b1.textContent='CBU (2) '+(w.alias2||'');
          b1.onclick = ()=>{ if(w.cbu2) { navigator.clipboard.writeText(w.cbu2); showToast('CBU 2 copiado'); } else showToast('CBU 2 vac√≠o'); };
          const b2=document.createElement('button'); b2.className='wallet-btn'; b2.style.borderColor=w.color2; b2.textContent='Alias (2) '+(w.alias2||'');
          b2.onclick = ()=>{ const txt = `${w.alias2||''}\nTitular ${w.titular2||''}`; navigator.clipboard.writeText(txt); showToast('Alias 2 copiado'); };
          back.appendChild(b1); back.appendChild(b2);
        } else {
          const p=document.createElement('div'); p.className='muted'; p.textContent='Sin dorso'; back.appendChild(p);
        }

        inner.appendChild(front); inner.appendChild(back);
        card.appendChild(inner);
        grid.appendChild(card);

        // set maxWidth based on second button + extra approx 378px
        requestAnimationFrame(()=>{
          try{
            const rectF2 = f2.getBoundingClientRect();
            const rectCard = card.getBoundingClientRect();
            const offset = Math.max(0, rectF2.right - rectCard.left);
            const extra = Math.round(10 * 37.8);
            const desired = offset + extra;
            const maxAllowed = Math.max(300, window.innerWidth - 80);
            card.style.maxWidth = Math.min(desired, maxAllowed) + 'px';
          }catch(e){}
        });
      });
      container.appendChild(grid); content.appendChild(container);
    }

    // persist simple local
    function saveLocal(){ try{ localStorage.setItem(STORAGE_PREFIX+'demo', JSON.stringify(config)); document.getElementById('chipStatus').textContent='Cambios guardados'; }catch(e){} }
    function loadLocal(){ try{ const raw = localStorage.getItem(STORAGE_PREFIX+'demo'); if(raw) config = JSON.parse(raw); }catch(e){} }

    // init bindings
    document.getElementById('btnAddWallet').addEventListener('click', ()=>{
      config.billeteras.push({ label:'Grupo', cbu:'', alias:'', titular:'', flip:false });
      ensureWalletColors(); renderWallets(); renderPreview(); saveLocal();
    });
    document.getElementById('waMensaje').addEventListener('input', (e)=>{ config.whatsapp.plantillaMensaje = e.target.value; saveLocal(); });
    document.getElementById('promoPrefix').addEventListener('input', (e)=>{ config.promoAmigo.prefix = e.target.value; saveLocal(); });

    // load & boot
    loadLocal(); ensureWalletColors(); renderWallets(); renderPreview();
  })();
  </script>
</body>
</html>
