<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dif ‚Ä¢ An√°lisis de Retenci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Pegado directo del CSS de Recu */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111418;
      color: white;
      padding: 24px;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 22px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(to right, #C7F24A, #A8A8A8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card { background-color: #1A1E23; border: 1px solid #2A2A2A; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); margin-top: 20px; }
    .controls { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; }
    label { font-size: 13px; color: #A8A8A8; }
    input[type="file"], input[type="number"] { background-color: #1E2329; border: 1px solid #2A2A2A; color: white; padding: 8px; border-radius: 8px; }
    input[type="checkbox"] { margin-right: 6px; }
    .btn { background: linear-gradient(to right, #C7F24A, #D4FF4A); color: #0D1117; font-weight: 700; padding: 10px 14px; border: none; border-radius: 10px; cursor: pointer; }
    .summary { display: flex; justify-content: space-between; margin-top: 16px; padding: 12px; background-color: #1E2329; border-radius: 8px; border: 1px solid #2A2A2A; }
    .badge { background-color: #24364A; color: #EAF2FF; padding: 6px 10px; border-radius: 8px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; background-color: #1E2329; border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #2A2A2A; font-size: 13px; }
    th { background-color: #1A1E23; color: #A8A8A8; position: sticky; top: 0; }
    tr:hover td { background-color: #24364A; }
    .copy-btn { background-color: #2A2F36; color: #EAF2FF; padding: 6px 10px; border-radius: 8px; font-size: 12px; border: none; cursor: pointer; margin-left: auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dif ‚Ä¢ An√°lisis de Retenci√≥n</h1>
    <p>Detecta usuarios que cargaron el mes anterior pero no el actual.</p>

    <div class="card">
      <div class="controls">
        <div>
          <label>MES ANTERIOR (CSV)</label><br>
          <input type="file" id="filePrev" accept=".csv">
        </div>
        <div>
          <label>MES ACTUAL (CSV)</label><br>
          <input type="file" id="fileCurr" accept=".csv">
        </div>
        <div>
          <label>FORMATO CSV</label><br>
          <button class="btn" onclick="setFormat(0)">MASTR</button>
          <button class="btn" onclick="setFormat(1)">AGENTE</button>
        </div>
        <div>
          <label><input type="checkbox" id="onlySingle"> S√≥lo usuarios con 1 carga (Mes anterior)</label>
        </div>
        <div>
          <label>L√≠mite filas</label><br>
          <input type="number" id="maxRows" value="0" min="0">
        </div>
        <div>
          <button class="btn" onclick="process()">üîç Procesar Comparaci√≥n</button>
          <button class="btn" onclick="toggleSort()">‚áÖ Orden: $$$</button>
        </div>
      </div>

      <div class="summary">
        <div>
          <strong id="summaryCount">Sin procesar</strong>
          <div class="badge" id="formatBadge">mastr</div>
        </div>
        <div>
          <span id="summaryUsers" class="badge">‚Äî</span>
        </div>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <script>
    let origin = 0;
    let sortMode = 'monto';
    let dropped = [];

    function setFormat(val) {
      origin = val;
      document.getElementById('formatBadge').textContent = val === 0 ? 'mastr' : 'agente';
    }

    function toggleSort() {
      sortMode = sortMode === 'monto' ? 'operaciones' : 'monto';
    }

    function process() {
      const prevFile = document.getElementById('filePrev').files[0];
      const currFile = document.getElementById('fileCurr').files[0];
      if (!prevFile || !currFile) return alert("Carg√° ambos archivos");

      Promise.all([readCSV(prevFile), readCSV(currFile)]).then(([prevLines, currLines]) => {
        const parser = origin === 0 ? parseMastr : parseAgente;
        const prev = parser(prevLines);
        const curr = parser(currLines);
        const currSet = new Set(curr.map(r => r.usuario));
        const map = {};
        prev.forEach(r => {
          if (!map[r.usuario]) map[r.usuario] = { usuario: r.usuario, monto: 0, count: 0, fecha: r.fecha };
          map[r.usuario].monto += r.monto;
          map[r.usuario].count += 1;
        });
        dropped = Object.values(map).filter(u => !currSet.has(u.usuario));
        if (document.getElementById('onlySingle').checked) dropped = dropped.filter(u => u.count === 1);
        render();
      });
    }

    function render() {
      const max = parseInt(document.getElementById('maxRows').value) || 0;
      const sorted = dropped.sort((a,b)=> sortMode==='monto' ? b.monto-a.monto : b.count-a.count);
      const limited = max > 0 ? sorted.slice(0,max) : sorted;
      document.getElementById('summaryCount').textContent = `${dropped.length} usuarios detectados`;
      document.getElementById('summaryUsers').textContent = `Mostrando ${limited.length}`;
      let html = `<table><thead><tr><th>Usuario</th><th>Monto</th><th>Apariciones</th></tr></thead><tbody>`;
      limited.forEach(u=>{
        html += `<tr><td>${u.usuario}</td><td>$${u.monto.toFixed(2)}</td><td>${u.count}</td></tr>`;
      });
      html += `</tbody></table><button class="copy-btn" onclick="copy()">Copiar lista</button>`;
      document.getElementById('results').innerHTML = html;
    }

    function copy() {
      const text = dropped.map(u=>`- ${u.usuario}`).join('\n');
      navigator.clipboard.writeText(text).then(()=>alert("Copiado"));
    }

    function readCSV(file) {
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = e => res(e.target.result.split(/\r?\n/).filter(l=>l.trim()));
        r.onerror = rej;
        r.readAsText(file);
      });
    }

    function parseMastr(lines) {
      return lines.map(l=>{
        const c = l.split(',');
        const monto = parseFloat((c[3]||'').replace(/[^\d.-]/g,''))||0;
        const usuario = (c[6]||c[5]||'').trim().toLowerCase();
        return { usuario, monto, fecha: c[0] };
      }).filter(r=>r.usuario);
    }

    function parseAgente(lines) {
      return lines.map(l=>{
        const c = l.split(',');
