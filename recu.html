<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial por Alias</title>
<style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    input, button { padding: 10px; font-size: 16px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #444; padding: 8px; }
    th { background: #222; }
</style>
</head>
<body>

<h2>Buscar movimientos por Alias</h2>

<input type="file" id="fileInput" multiple>
<br><br>
<input type="text" id="aliasInput" placeholder="Ingresá el alias exacto">
<button onclick="filtrar()">Buscar</button>

<h3 id="resultado"></h3>

<table id="tabla">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Cantidad</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// ----------------------------------------
//  LEE Y LIMPIA EL CSV
// ----------------------------------------
function parseCSV(text) {

    text = text.replace(/^sep=.*\n/gi, ""); // elimina la fila basura

    const rows = text.trim().split("\n");
    const headers = rows[0].split(",").map(h => h.trim());

    const fechaIdx = headers.indexOf("Fecha");
    const cantidadIdx = headers.indexOf("Cantidad");
    const aliasIdx = headers.indexOf("Alias");

    return rows.slice(1).map(row => {
        const cols = row.split(",");
        return {
            fecha: cols[fechaIdx]?.trim(),
            cantidad: Number(cols[cantidadIdx]?.trim() || 0),
            alias: cols[aliasIdx]?.trim()
        };
    });
}

let datos = [];

// ----------------------------------------
//  LECTURA DE ARCHIVOS
// ----------------------------------------
document.getElementById("fileInput").addEventListener("change", function(e) {

    datos = [];
    const files = e.target.files;

    Array.from(files).forEach(file => {

        const reader = new FileReader();
        reader.onload = function(event) {
            const contenido = event.target.result;
            const parsed = parseCSV(contenido);
            datos = datos.concat(parsed);
        };
        
        reader.readAsText(file);
    });

});

// ----------------------------------------
//  FILTRA POR ALIAS Y MUESTRA DATOS
// ----------------------------------------
function filtrar() {

    const alias = document.getElementById("aliasInput").value.trim();
    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";

    if (!alias) {
        alert("Ingresá un alias.");
        return;
    }

    const filtrados = datos.filter(d => d.alias?.toLowerCase() === alias.toLowerCase());

    if (filtrados.length === 0) {
        document.getElementById("resultado").innerText = "No se encontraron movimientos.";
        return;
    }

    // ordenar por fecha
    filtrados.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

    // calcular total
    const total = filtrados.reduce((acc, op) => acc + op.cantidad, 0);

    document.getElemen
