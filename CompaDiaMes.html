<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Comparador AGENTE ⇄ CHUNIOR — Herramienta</title>
<style>
  :root{
    --bg:#071227; --card:#0b1722; --muted:#9fb6c7; --accent:#06b6d4; --ok:#2ecc71; --bad:#e04747; --warn:#ffbf3c;
    --glass: rgba(255,255,255,0.03);
    --text:#e6f7fb;
    --border-color: rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071020,#071827);color:var(--text);padding:18px;}
  .wrap{max-width:1200px;margin:0 auto}
  h1{margin:0 0 8px 0;font-size:20px}
  .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:12px;border-radius:10px;border:1px solid var(--border-color);box-shadow:0 6px 20px rgba(0,0,0,0.5)}
  .row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=file]{background:var(--glass);padding:8px;border-radius:8px;border:1px dashed var(--border-color);color:var(--muted);width:100%;}
  textarea{width:100%;min-height:140px;background:var(--glass);border-radius:8px;padding:10px;border:1px solid var(--border-color);color:var(--text);resize:vertical}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),#3dd9f0);color:#042a31;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer;transition:transform 0.1s ease-out}
  .btn:active{transform:translateY(1px)}
  .small{padding:8px 10px;font-size:13px}
  .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color)}
  select{background:var(--glass);border-radius:8px;padding:8px;border:1px solid var(--border-color);color:var(--text);-webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239fb6c7'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 20px;}
  .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px;color:var(--muted);font-size:14px;padding-top:10px;border-top:1px solid var(--border-color)}
  .summary .badge {text-align:center; padding:10px; background:var(--glass); border-radius:8px; border:1px solid var(--border-color); display:flex; flex-direction:column; align-items:center; justify-content:center;}
  .summary .badge strong {font-size:1.4em; color:var(--text); margin-top:5px;}
  .summary .badge.diff strong {color:var(--bad);}
  .summary .badge.ok strong {color:var(--ok);}

  .table-wrap{margin-top:12px;max-height:520px;overflow:auto;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid var(--border-color)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border-color);text-align:left;vertical-align:middle}
  th{position:sticky;top:0;background:rgba(0,0,0,0.3);z-index:3;color:#dff6fb;font-weight:600}
  tr.ok td{background:rgba(46,204,113,0.04);border-left:2px solid var(--ok);}
  tr.miss-chunior td{background:rgba(224,71,71,0.04);border-left:2px solid var(--bad);}
  tr.miss-agente td{background:rgba(255,190,60,0.04);border-left:2px solid var(--warn);}
  .badge{padding:6px 8px;border-radius:8px;background:var(--glass);color:var(--muted);font-size:12px;}
  .state-ok{color:var(--ok);font-weight:700}
  .state-bad{color:var(--bad);font-weight:800}
  .state-warn{color:var(--warn);font-weight:800}
  .controls-vertical{display:flex;flex-direction:column;gap:8px}
  .notes{margin-top:10px;color:var(--muted);font-size:13px}
  .flex-col {display:flex; flex-direction:column; gap:4px;}

  @media (max-width:920px){ 
    .row{flex-direction:column} 
    .filters{flex-direction:column;align-items:stretch} 
    .summary{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Comparador AGENTE ⇄ CHUNIOR</h1>
  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:280px">
        <label>Cargar CSV(s) AGENTE (puedes seleccionar varios)</label>
        <input id="agentFiles" type="file" accept=".csv" multiple />
        <div class="notes">Nombra los archivos (ej. `agente_chino.csv`) para identificar la fuente. Se detecta formato principal o sub-agente.</div>
      </div>

      <div style="flex:1;min-width:300px">
        <label>Pegar texto CHUNIOR (todo el día / turno, varias líneas)</label>
        <textarea id="chuniorText" placeholder="Pega aquí las líneas copiadas de Chunior..."></textarea>
        <div class="notes">Ejemplo: <code>7007867    10-11-2025 13:48:45    fyeivan    682 - LUNA    $ 3.000,00    clau3628</code></div>
      </div>

      <div style="width:220px">
        <label>Acciones</label>
        <div class="controls-vertical">
          <button id="processBtn" class="btn small">Procesar y emparejar</button>
          <button id="exportBtn" class="small btn" style="background:linear-gradient(90deg,#f59e0b,#f97316)">Exportar CSV</button>
          <button id="copyExcelBtn" class="small btn" style="background:linear-gradient(90deg,#06b6d4,#3dd9f0)">Copiar para Excel</button>
        </div>
      </div>
    </div>

    <div class="summary" id="summaryBox">
      <div class="badge">Total Agente: <strong id="sumAgentTotal">0.00</strong></div>
      <div class="badge">Total Chunior: <strong id="sumChuniorTotal">0.00</strong></div>
      <div class="badge diff">Diferencia Total: <strong id="sumDifference">0.00</strong></div>
      <div class="badge ok">Ingresos Agente: <strong id="sumAgentIncome">0.00</strong></div>
      <div class="badge ok">Ingresos Chunior: <strong id="sumChuniorIncome">0.00</strong></div>
      <div class="badge diff">Dif. Ingresos: <strong id="sumDiffIncome">0.00</strong></div>
      <div class="badge bad">Egresos Agente: <strong id="sumAgentOutcome">0.00</strong></div>
      <div class="badge bad">Egresos Chunior: <strong id="sumChuniorOutcome">0.00</strong></div>
      <div class="badge diff">Dif. Egresos: <strong id="sumDiffOutcome">0.00</strong></div>
    </div>


    <div class="filters">
      <div class="badge">Registros totales: <span id="countTotals">0</span></div>
      <div><label>Agente</label><select id="filterAgente"><option value="__ALL">Todos</option></select></div>
      <div><label>Operador</label><select id="filterOperador"><option value="__ALL">Todos</option></select></div>
      <div><label>Billetera</label><select id="filterBilletera"><option value="__ALL">Todas</option></select></div>
      <div><label>Turno</label><select id="filterTurno"><option value="__ALL">Todos</option><option value="TM">Mañana (06-14)</option><option value="TT">Tarde (14-22)</option><option value="TN">Noche (22-06)</option></select></div>
      <div><label>Estado</label><select id="filterEstado"><option value="__ALL">Todos</option><option value="OK">OK</option><option value="MISSING_CHUNIOR">Falta en CHUNIOR</option><option value="MISSING_AGENT">Falta en AGENTE</option></select></div>
      <div><label>Tipo Mov.</label><select id="filterMovimiento"><option value="__ALL">Todos</option><option value="INGRESO">Ingresos</option><option value="EGRESO">Egresos</option></select></div>
      <div style="margin-left:auto" class="badge">Emparejados: <span id="countPaired">0</span> · Discrepancias: <span id="countMissing">0</span></div>
    </div>

    <div id="tableContainer" class="table-wrap" aria-live="polite" style="margin-top:12px">
      <table id="resultsTable" role="table">
        <thead>
          <tr>
            <th style="min-width:50px">Agente</th>
            <th style="min-width:60px">Turno</th>
            <th style="min-width:100px">Agente hora</th>
            <th style="min-width:120px">Agente usuario</th>
            <th style="min-width:90px">Agente monto</th>
            <th style="min-width:100px">Chunior hora</th>
            <th style="min-width:120px">Chunior usuario</th>
            <th style="min-width:90px">Chunior monto</th>
            <th style="min-width:100px">Operador</th>
            <th style="min-width:100px">Billetera</th>
            <th style="min-width:80px">Estado</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div class="notes" style="margin-top:12px">
      • Matching exacto por <strong>usuario normalizado (minúsc)</strong> y <strong>monto</strong> — cualquier diferencia marca discrepancia.<br>
      • Turnos: Mañana 06:00–14:00, Tarde 14:00–22:00, Noche 22:00–06:00.
    </div>
  </div>
</div>

<script>
/* UTIL: lectura CSV robusta (returns array of lines without header if detected) */
function readFileAsText(file){
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => res(String(e.target.result || ''));
    r.onerror = rej;
    r.readAsText(file, 'utf-8');
  });
}
function splitLines(text){
  // Remove BOM if present, then split
  return text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l => l.trim() !== '');
}
/* parse CSV line with quotes */
function parseCSVLine(line, delimiter = ','){
  const out = [];
  let cur = '', inQuotes=false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"' ) {
      if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes; continue;
    }
    if (ch === delimiter && !inQuotes){ out.push(cur); cur=''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* CLEAN amount strings:
   AGENT CSV likely "4000" or "4.000,00" or "4000.00" => normalize to Number (float)
   CHUNIOR sample: "$ 3.000,00" => remove $, spaces, convert
*/
function parseAmountRaw(raw){
  if(raw === null || raw === undefined) return 0;
  let s = String(raw).trim();
  if(!s) return 0;
  // remove currency signs and non-numeric chars except for comma and dot
  s = s.replace(/[^\d\-,\.]/g, '');

  // Handle common numeric formats (e.g., "1.000,00" vs "1,000.00" vs "1000,00")
  // If it contains both '.' and ',' and ',' is last -> assume European (thousands sep '.', decimal ',')
  if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
    if (s.indexOf(',') > s.indexOf('.')) { // European format: 1.000,00
      s = s.replace(/\./g, '').replace(/,/g, '.');
    } else { // US format: 1,000.00
      s = s.replace(/,/g, '');
    }
  } else if (s.indexOf(',') !== -1) { // Only comma, assume European decimal
    s = s.replace(/,/g, '.');
  }
  // Remove any remaining thousands separators (dots that aren't decimals if it was US format)
  s = s.replace(/(\d)\.(\d{3})/g, '$1$2'); // Remove dots that are clearly thousands separators in numbers like 1.234

  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}


/* parse agent CSV rows array (lines)
   We try to detect two formats:
   1. Sub-agente: Fecha,Tipo,Estado,Cantidad,Balance,Alias del agente,Alias del jugador (Cantidad is col 3)
   2. Agente principal: Fecha,Estado,Cantidad,Tipo,Alias,Balance (Cantidad is col 2) -> Quantity can be negative here for withdrawals
   Also detect 'sep=,' line and ignore first header line.
*/
function parseAgentLines(lines, agentName = 'Desconocido'){
  const rows = [];
  let startIndex = 0;
  let isSubAgentFormat = false; // Flag to determine format

  if(lines.length === 0) return rows;

  // Check for 'sep=,' and skip it
  if(lines[0].toLowerCase().startsWith('sep=')){
    startIndex = 1;
  }
  // Try to determine format from header
  const headerLine = lines[startIndex];
  if (headerLine){
    const headerCols = parseCSVLine(headerLine);
    // Check for 'Cantidad' at index 3 (Sub-agente format)
    if(headerCols[3] && headerCols[3].toLowerCase() === 'cantidad' && headerCols[6] && headerCols[6].toLowerCase() === 'alias del jugador'){
      isSubAgentFormat = true;
    } else if (headerCols[2] && headerCols[2].toLowerCase() === 'cantidad' && headerCols[4] && headerCols[4].toLowerCase() === 'alias'){
      // Agente principal format
      isSubAgentFormat = false; // Explicitly set false for clarity
    } else {
        // Fallback or guess: check if 'Tipo' is at index 1 for sub-agent (Fecha,Tipo,Estado,...)
        // or 'Estado' at index 1 for main agent (Fecha,Estado,Cantidad,...)
        if (headerCols[1] && headerCols[1].toLowerCase() === 'tipo' && headerCols[3] && headerCols[3].toLowerCase() === 'cantidad') {
            isSubAgentFormat = true;
        } else if (headerCols[1] && headerCols[1].toLowerCase() === 'estado' && headerCols[2] && headerCols[2].toLowerCase() === 'cantidad') {
            isSubAgentFormat = false;
        } else {
             console.warn('Could not determine CSV format for agent file, assuming sub-agent format as default.');
             isSubAgentFormat = true; // Default to sub-agent if cannot detect
        }
    }
    startIndex++; // Skip the header line once format is determined
  }

  for (let i=startIndex;i<lines.length;i++){
    const line = lines[i];
    if(!line.trim()) continue;
    const cols = parseCSVLine(line);

    const fechaRaw = (cols[0]||'').trim();
    let montoRaw, usuarioRaw;

    if(isSubAgentFormat){
      // Fecha,Tipo,Estado,Cantidad,Balance,Alias del agente,Alias del jugador
      montoRaw = (cols[3] || '');
      usuarioRaw = (cols[6] || '').trim();
    } else {
      // Fecha,Estado,Cantidad,Tipo,Alias,Balance (Agente principal)
      montoRaw = (cols[2] || ''); // Cantidad is col 2
      usuarioRaw = (cols[4] || '').trim(); // Alias is col 4
    }

    const monto = parseAmountRaw(montoRaw);
    const usuario = usuarioRaw ? String(usuarioRaw).toLowerCase().trim() : '';

    let fechaObj = null;
    if(fechaRaw){
      // Try to parse YYYY-MM-DD HH:MM:SS format
      const attempt = new Date(fechaRaw.replace(' ', 'T'));
      fechaObj = isNaN(attempt.getTime()) ? new Date(fechaRaw) : attempt;
      if(isNaN(fechaObj.getTime())) fechaObj = null;
    }
    rows.push({ origen:'AGENT', agente: agentName, fecha: fechaRaw, fechaObj, monto, usuario });
  }
  return rows;
}


/* parse chunior pasted text.
   Example line:
   7007867    10-11-2025 13:48:45    fyeivan    682 - LUNA    $ 3.000,00    clau3628
   We split by tabs or 2+ spaces.
*/
function parseChuniorLines(lines){
  const rows = [];
  for (let raw of lines){
    if(!raw.trim()) continue;
    // split by tab or multiple spaces
    let parts = raw.split(/\t+/).map(p => p.trim()).filter(Boolean);
    if(parts.length < 2){
      parts = raw.split(/\s{2,}/).map(p => p.trim()).filter(Boolean);
    }
    // If first token is numeric ID, drop it
    if(parts.length >= 6 && /^\d+$/.test(parts[0])) parts.shift();
    // Now expected: [date-time, operador, billetera-info, monto, usuario]
    // Some variants: date-time may be split in two tokens like '10-11-2025' and '13:48:45'
    if(parts.length >= 5 && /^\d{2}-\d{2}-\d{4}$/.test(parts[0]) && /^\d{2}:\d{2}:\d{2}$/.test(parts[1])){
      // merge date and time
      parts[0] = parts[0] + ' ' + parts[1];
      parts.splice(1,1);
    }
    // now try to assign parts to variables
    // 10-11-2025 13:48:45    fyeivan    682 - LUNA    $ 3.000,00    clau3628
    // Assuming parts are: [fecha, operador, billetera, monto, usuario] after processing date/id
    let fechaRaw = parts[0] || '';
    let operador = parts[1] || '';
    let billeteraRaw = parts[2] || '';
    let montoRaw = parts[3] || '';
    let usuarioRaw = parts[4] || ''; // This is often the last part

    // Clean billetera (e.g., '682 - LUNA' => 'LUNA')
    let billetera = billeteraRaw.replace(/.*-\s*/,'').trim();
    if(!billetera) billetera = billeteraRaw.trim(); // Fallback if no hyphen
    
    const monto = parseAmountRaw(montoRaw);
    const usuario = usuarioRaw ? String(usuarioRaw).toLowerCase().trim() : '';
    
    // Parse date
    let fechaObj = null;
    if(fechaRaw){
      // Try dd-mm-yyyy hh:mm:ss -> convert to yyyy-mm-ddThh:mm:ss
      const m = fechaRaw.match(/(\d{2})-(\d{2})-(\d{4})\s+(\d{2}:\d{2}:\d{2})/);
      if(m){
        fechaObj = new Date(`${m[3]}-${m[2]}-${m[1]}T${m[4]}`);
      } else {
        const attempt = new Date(fechaRaw.replace(' ', 'T'));
        fechaObj = isNaN(attempt.getTime()) ? null : attempt;
      }
    }
    rows.push({ origen:'CHUNIOR', fecha: fechaRaw, fechaObj, monto, usuario, operador: operador.toLowerCase().trim(), billetera: billetera.toUpperCase().trim() });
  }
  return rows;
}

/* turno calculation */
function getTurnoFromDate(d){
  if(!d || isNaN(d.getTime())) return ''; // Empty string for unknown/invalid date
  const h = d.getHours();
  if(h >= 6 && h < 14) return 'TM';
  if(h >= 14 && h < 22) return 'TT';
  return 'TN';
}

/* MAIN processing */
document.getElementById('processBtn').addEventListener('click', async ()=>{
  const inputFiles = document.getElementById('agentFiles').files;
  const chuniorText = document.getElementById('chuniorText').value || '';
  const resultsBody = document.getElementById('resultsBody');
  resultsBody.innerHTML = '';

  // read all agent files
  let allAgentRows = [];
  if(inputFiles && inputFiles.length){
    try{
      for(const f of inputFiles){
        const txt = await readFileAsText(f);
        const lines = splitLines(txt);
        // Extract agent name from filename (e.g., "agente_chino.csv" -> "chino")
        const agentNameMatch = f.name.match(/(agente|subagente)_?([a-zA-Z0-9]+)/i);
        const agentName = agentNameMatch && agentNameMatch[2] ? agentNameMatch[2].toLowerCase() : f.name.replace(/\.csv$/i, '');
        
        allAgentRows = allAgentRows.concat(parseAgentLines(lines, agentName));
      }
    } catch(e){
      alert('Error leyendo archivos de agente: ' + (e && e.message ? e.message : e));
      console.error(e);
      return;
    }
  }

  const chuniorLines = splitLines(chuniorText);
  const chuniorRows = parseChuniorLines(chuniorLines);

  // enhance with turno
  allAgentRows.forEach(r => {
    r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : '';
    r.tipoMovimiento = r.monto < 0 ? 'EGRESO' : 'INGRESO';
  });
  chuniorRows.forEach(r => {
    r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : '';
    r.tipoMovimiento = r.monto < 0 ? 'EGRESO' : 'INGRESO';
  });

  // Sort Chunior rows by date to handle potential out-of-order entries for matching
  // This is crucial for matching in sequence
  chuniorRows.sort((a,b) => (a.fechaObj && b.fechaObj) ? a.fechaObj.getTime() - b.fechaObj.getTime() : 0);

  // matching exact: for each AGENT record find first unmatched CHUNIOR where usuario==usuario && monto==monto
  const matchedChuniorIdx = new Set();
  const pairs = [];
  for (let i=0;i<allAgentRows.length;i++){
    const a = allAgentRows[i];
    let matchedIndex = -1;
    for (let j=0;j<chuniorRows.length;j++){
      if(matchedChuniorIdx.has(j)) continue;
      const c = chuniorRows[j];
      if(!a.usuario || !c.usuario) continue; // Must have user
      
      // Match exactly on user and amount
      if(a.usuario === c.usuario && Math.abs((a.monto||0) - (c.monto||0)) < 0.01){ // Allow small float deviation
        matchedIndex = j; break;
      }
    }
    if(matchedIndex >= 0){
      matchedChuniorIdx.add(matchedIndex);
      pairs.push({ agente: a, chunior: chuniorRows[matchedIndex], estado: 'OK', tipoMovimiento: a.tipoMovimiento || 'UNKNOWN' });
    } else {
      pairs.push({ agente: a, chunior: null, estado: 'MISSING_CHUNIOR', tipoMovimiento: a.tipoMovimiento || 'UNKNOWN' });
    }
  }
  // any chunior left unmatched -> missing agent
  for (let j=0;j<chuniorRows.length;j++){
    if(!matchedChuniorIdx.has(j)){
      const c = chuniorRows[j];
      pairs.push({ agente: null, chunior: c, estado: 'MISSING_AGENT', tipoMovimiento: c.tipoMovimiento || 'UNKNOWN' });
    }
  }

  // populate filter selects: agentes / operadores / billeteras
  const agentes = new Set(), operadores = new Set(), billeteras = new Set();
  allAgentRows.forEach(r => { if(r.agente) agentes.add(r.agente); });
  chuniorRows.forEach(r => { if(r.operador) operadores.add(r.operador); if(r.billetera) billeteras.add(r.billetera); });

  // Agente filter
  const agSel = document.getElementById('filterAgente');
  agSel.innerHTML = '<option value="__ALL">Todos</option>';
  Array.from(agentes).sort().forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o.toUpperCase(); agSel.appendChild(opt); });

  // Operador filter
  const opSel = document.getElementById('filterOperador');
  opSel.innerHTML = '<option value="__ALL">Todos</option>';
  Array.from(operadores).sort().forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o.toUpperCase(); opSel.appendChild(opt); });
  
  // Billetera filter
  const biSel = document.getElementById('filterBilletera');
  biSel.innerHTML = '<option value="__ALL">Todas</option>';
  Array.from(billeteras).sort().forEach(b => { const opt = document.createElement('option'); opt.value = b; opt.textContent = b.toUpperCase(); biSel.appendChild(opt); });

  // store global arrays for filtering/export
  window.__COMPARE_PAIRS = pairs;

  // render
  renderTable();
  updateSummary();
});

/* render table with filters */
function renderTable(){
  const pairs = window.__COMPARE_PAIRS || [];
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  
  const agFilter = document.getElementById('filterAgente').value;
  const opFilter = document.getElementById('filterOperador').value;
  const biFilter = document.getElementById('filterBilletera').value;
  const turnoFilter = document.getElementById('filterTurno').value;
  const estadoFilter = document.getElementById('filterEstado').value;
  const movimientoFilter = document.getElementById('filterMovimiento').value;

  let shown = 0;
  for(const p of pairs){
    const a = p.agente;
    const c = p.chunior;
    
    // Apply filters
    if(agFilter !== '__ALL' && (!a || a.agente !== agFilter)) continue;
    if(opFilter !== '__ALL' && (!c || c.operador !== opFilter)) continue;
    if(biFilter !== '__ALL' && (!c || c.billetera !== biFilter)) continue;
    if(turnoFilter !== '__ALL'){
      const t = (a && a.turno) || (c && c.turno) || '';
      if(t !== turnoFilter) continue;
    }
    if(estadoFilter !== '__ALL' && p.estado !== estadoFilter) continue;
    if(movimientoFilter !== '__ALL' && p.tipoMovimiento !== movimientoFilter) continue;


    const tr = document.createElement('tr');
    let statusClass = '';
    if (p.estado === 'OK') statusClass = 'ok';
    else if (p.estado === 'MISSING_CHUNIOR') statusClass = 'miss-chunior';
    else if (p.estado === 'MISSING_AGENT') statusClass = 'miss-agente';
    tr.className = statusClass;

    const agenteName = a && a.agente ? a.agente.toUpperCase() : '';
    const turno = (a && a.turno) || (c && c.turno) || '';
    const agenteHora = a && a.fechaObj ? formatTime(a.fechaObj) : (a && a.fecha) || '';
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteMonto = a ? (a.monto ? a.monto.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00') : '';
    const chuniorHora = c && c.fechaObj ? formatTime(c.fechaObj) : (c && c.fecha) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c ? (c.monto ? c.monto.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00') : '';
    const operador = c && c.operador ? c.operador.toUpperCase() : '';
    const billetera = c && c.billetera ? c.billetera : '';
    let estadoDisplay = '';
    if (p.estado === 'OK') estadoDisplay = '<span class="state-ok">✔ OK</span>';
    else if (p.estado === 'MISSING_CHUNIOR') estadoDisplay = '<span class="state-bad">❌ Falta CH</span>';
    else if (p.estado === 'MISSING_AGENT') estadoDisplay = '<span class="state-warn">❌ Falta AG</span>';


    tr.innerHTML = `
      <td>${escapeHtml(agenteName)}</td>
      <td>${turno}</td>
      <td>${escapeHtml(agenteHora)}</td>
      <td>${escapeHtml(agenteUsuario)}</td>
      <td>$ ${agenteMonto}</td>
      <td>${escapeHtml(chuniorHora)}</td>
      <td>${escapeHtml(chuniorUsuario)}</td>
      <td>$ ${chuniorMonto}</td>
      <td>${escapeHtml(operador)}</td>
      <td>${escapeHtml(billetera)}</td>
      <td>${estadoDisplay}</td>
    `;
    tbody.appendChild(tr);
    shown++;
  }
  document.getElementById('countTotals').textContent = `${shown} registros visibles`;
  document.getElementById('countPaired').textContent = pairs.filter(p=>p.estado==='OK').length;
  document.getElementById('countMissing').textContent = pairs.filter(p=>p.estado !== 'OK').length;
}

/* Update Summary Box */
function updateSummary(){
  const pairs = window.__COMPARE_PAIRS || [];
  let agentTotal = 0, chuniorTotal = 0;
  let agentIncome = 0, chuniorIncome = 0;
  let agentOutcome = 0, chuniorOutcome = 0;

  pairs.forEach(p => {
    if (p.agente) {
      agentTotal += p.agente.monto;
      if (p.agente.monto >= 0) agentIncome += p.agente.monto;
      else agentOutcome += p.agente.monto;
    }
    if (p.chunior) {
      chuniorTotal += p.chunior.monto;
      if (p.chunior.monto >= 0) chuniorIncome += p.chunior.monto;
      else chuniorOutcome += p.chunior.monto;
    }
  });

  const difference = agentTotal - chuniorTotal;
  const diffIncome = agentIncome - chuniorIncome;
  const diffOutcome = agentOutcome - chuniorOutcome;

  document.getElementById('sumAgentTotal').textContent = agentTotal.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumChuniorTotal').textContent = chuniorTotal.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumDifference').textContent = difference.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  
  document.getElementById('sumAgentIncome').textContent = agentIncome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumChuniorIncome').textContent = chuniorIncome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumDiffIncome').textContent = diffIncome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

  document.getElementById('sumAgentOutcome').textContent = agentOutcome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumChuniorOutcome').textContent = chuniorOutcome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sumDiffOutcome').textContent = diffOutcome.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}


/* helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function formatTime(d){ 
  if(!d || isNaN(d.getTime())) return ''; 
  // Custom format: DD/MM/YYYY HH:MM:SS
  const pad = (num) => num.toString().padStart(2, '0');
  return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* filters change */
['filterAgente','filterOperador','filterBilletera','filterTurno','filterEstado', 'filterMovimiento'].forEach(id=>{
  document.getElementById(id).addEventListener('change', renderTable);
});

/* EXPORT CSV */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const pairs = window.__COMPARE_PAIRS || [];
  if(!pairs.length){ alert('No hay datos para exportar.'); return; }
  // build CSV header
  const headers = ['AGENTE_NOMBRE','TURNO','AGENTE_HORA','AGENTE_USUARIO','AGENTE_MONTO','CHUNIOR_HORA','CHUNIOR_USUARIO','CHUNIOR_MONTO','OPERADOR','BILLETERA','ESTADO','TIPO_MOVIMIENTO'];
  const rows = [headers.join(',')];
  for(const p of pairs){
    const a = p.agente;
    const c = p.chunior;
    const agenteName = a && a.agente ? a.agente.toUpperCase() : '';
    const turno = (a && a.turno) || (c && c.turno) || '';
    const agenteHora = a && a.fechaObj ? a.fechaObj.toISOString() : (a && csvSafe(a.fecha)) || '';
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteMonto = a && a.monto ? a.monto.toFixed(2) : '';
    const chuniorHora = c && c.fechaObj ? c.fechaObj.toISOString() : (c && csvSafe(c.fecha)) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c && c.monto ? c.monto.toFixed(2) : '';
    const operador = c && c.operador ? c.operador.toUpperCase() : '';
    const billetera = c && c.billetera ? c.billetera : '';
    const estado = p.estado;
    const tipoMovimiento = p.tipoMovimiento || '';
    const row = [csvSafe(agenteName), csvSafe(turno), csvSafe(agenteHora), csvSafe(agenteUsuario), csvSafe(agenteMonto), csvSafe(chuniorHora), csvSafe(chuniorUsuario), csvSafe(chuniorMonto), csvSafe(operador), csvSafe(billetera), csvSafe(estado), csvSafe(tipoMovimiento)].join(',');
    rows.push(row);
  }
  const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `comparacion_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

function csvSafe(v){
  if(v === null || v === undefined) return '';
  let s = String(v).replace(/"/g,'""');
  // Check if string contains comma, double quote or newline. If so, wrap in quotes.
  if(s.includes(',') || s.includes('"') || s.includes('\n')) s = `"${s}"`;
  return s;
}

/* Copy for Excel: builds simple two-column-ish paste with AGENTE user in col A and TURNO in col G? 
   The user requested earlier a specialized copy — here we copy rows as TSV so you can paste into Sheets nicely.
   We'll export columns: AGENTE_NOMBRE, TURNO, AGENTE_HORA, AGENTE_USUARIO, AGENTE_MONTO, CHUNIOR_HORA, CHUNIOR_USUARIO, CHUNIOR_MONTO, OPERADOR, BILLETERA, ESTADO, TIPO_MOVIMIENTO
*/
document.getElementById('copyExcelBtn').addEventListener('click', async ()=>{
  const pairs = window.__COMPARE_PAIRS || [];
  if(!pairs.length){ alert('No hay datos para copiar'); return; }
  const lines = [];
  // header
  lines.push(['AGENTE_NOMBRE','TURNO','AGENTE_HORA','AGENTE_USUARIO','AGENTE_MONTO','CHUNIOR_HORA','CHUNIOR_USUARIO','CHUNIOR_MONTO','OPERADOR','BILLETERA','ESTADO','TIPO_MOVIMIENTO'].join('\t'));
  for(const p of pairs){
    const a = p.agente, c = p.chunior;
    const agenteName = a && a.agente ? a.agente.toUpperCase() : '';
    const turno = (a && a.turno) || (c && c.turno) || '';
    const agenteHora = a && a.fechaObj ? formatTime(a.fechaObj) : (a && a.fecha) || '';
    const agenteUsuario = a && a.usuario ? a.usuario : '';
    const agenteMonto = a && a.monto ? a.monto.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
    const chuniorHora = c && c.fechaObj ? formatTime(c.fechaObj) : (c && c.fecha) || '';
    const chuniorUsuario = c && c.usuario ? c.usuario : '';
    const chuniorMonto = c && c.monto ? c.monto.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
    const operador = c && c.operador ? c.operador.toUpperCase() : '';
    const billetera = c && c.billetera ? c.billetera : '';
    const estado = p.estado;
    const tipoMovimiento = p.tipoMovimiento || '';
    const row = [agenteName, turno, agenteHora, agenteUsuario, agenteMonto, chuniorHora, chuniorUsuario, chuniorMonto, operador, billetera, estado, tipoMovimiento].join('\t');
    lines.push(row);
  }
  const tsv = lines.join('\n');
  try{
    await navigator.clipboard.writeText(tsv);
    alert('Copiado al portapapeles como TSV — pegalo en Google Sheets o Excel');
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = tsv;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert('Copiado (fallback). Pega en Sheets.');
  }
});

/* small utility: re-render when stored pairs updated (if needed) */
window.reRenderCompare = renderTable;
</script>
</body>
</html>
